<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>AVR32 - FAT Services: fat.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>fat.c</h1><a href="a00024.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00014"></a>00014 <span class="comment">/* Copyright (c) 2009 Atmel Corporation. All rights reserved.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00017"></a>00017 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice, this</span>
<a name="l00020"></a>00020 <span class="comment"> * list of conditions and the following disclaimer.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00023"></a>00023 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00024"></a>00024 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * 3. The name of Atmel may not be used to endorse or promote products derived</span>
<a name="l00027"></a>00027 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * 4. This software may only be redistributed and used in connection with an Atmel</span>
<a name="l00030"></a>00030 <span class="comment"> * AVR product.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED</span>
<a name="l00033"></a>00033 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00034"></a>00034 <span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE</span>
<a name="l00035"></a>00035 <span class="comment"> * EXPRESSLY AND SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR</span>
<a name="l00036"></a>00036 <span class="comment"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00038"></a>00038 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00039"></a>00039 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00040"></a>00040 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<a name="l00041"></a>00041 <span class="comment"> * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE</span>
<a name="l00042"></a>00042 <span class="comment"> *</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a><a class="code" href="a00024.html#de9a4ddf526f95045c8e8f772662988f">00044</a> <span class="preprocessor">#define _fat_c_</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="comment">//_____  I N C L U D E S ___________________________________________________</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="a00021.html" title="FAT configuration file.">conf_explorer.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="a00031.html" title="FAT 12/16/32 Services.">fs_com.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="a00025.html" title="FAT services.">fat.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include LIB_MEM</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#include LIB_CTRLACCESS</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">//_____ D E F I N I T I O N S ______________________________________________</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00059"></a>00059 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00060"></a><a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">00060</a> <span class="preprocessor"></span>_MEM_TYPE_SLOW_     <a class="code" href="a00009.html" title="Struture to save the variables frequently used by file system mounted.">Fs_management</a>       <a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[<a class="code" href="a00021.html#8ab6bd77e49639be7dc419bcf66bd73f" title="Maximal number of simultaneous navigators.">FS_NB_NAVIGATOR</a>-1];
<a name="l00061"></a><a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">00061</a> _MEM_TYPE_SLOW_     <a class="code" href="a00011.html" title="Struture to save the variables very frequently used by file system mounted.">Fs_management_fast</a>  <a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[<a class="code" href="a00021.html#8ab6bd77e49639be7dc419bcf66bd73f" title="Maximal number of simultaneous navigators.">FS_NB_NAVIGATOR</a>-1];
<a name="l00062"></a><a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">00062</a> _MEM_TYPE_SLOW_     <a class="code" href="a00010.html" title="Struture to save the frequently variables of file system mounted.">Fs_management_entry</a> <a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[<a class="code" href="a00021.html#8ab6bd77e49639be7dc419bcf66bd73f" title="Maximal number of simultaneous navigators.">FS_NB_NAVIGATOR</a>-1];
<a name="l00063"></a>00063 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00068"></a><a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">00068</a> <span class="preprocessor">_MEM_TYPE_SLOW_     Fs_clusterlist_cache fs_g_cache_clusterlist[FS_NB_CACHE_CLUSLIST*2];</span>
<a name="l00069"></a><a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">00069</a> <span class="preprocessor"></span>_MEM_TYPE_SLOW_     U8  <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">//_____ D E C L A R A T I O N S ____________________________________________</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="keywordtype">void</span>  <a class="code" href="a00024.html#98a226b82d5df9c085d050fb341d8c6c" title="This function initializes a cache in cluster list caches.">fat_cache_clusterlist_update_start</a>  ( Bool b_for_file );
<a name="l00076"></a>00076 <span class="keywordtype">void</span>  <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a> ( <span class="keywordtype">void</span> );
<a name="l00077"></a>00077 Bool  <a class="code" href="a00024.html#b4f9f4f20c7e1ef6fa76ddc52cdc54f1" title="This function searchs a cluster list in cluster list caches.">fat_cache_clusterlist_update_read</a>   ( Bool b_for_file );
<a name="l00078"></a>00078 <span class="keywordtype">void</span>  <a class="code" href="a00024.html#000e1da834dabe29da28f2110f8ba6c9" title="This function signals that a cache is used.">fat_cache_clusterlist_update_select</a> ( <span class="keywordtype">void</span> );
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 
<a name="l00091"></a><a class="code" href="a00025.html#eeec0bd6755a6be4c4dda2b4669eb0ae">00091</a> Bool  <a class="code" href="a00024.html#eeec0bd6755a6be4c4dda2b4669eb0ae" title="This function checks device state.">fat_check_device</a>( <span class="keywordtype">void</span> )
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093    U8 retry=0;
<a name="l00094"></a>00094 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>   U8 i;
<a name="l00096"></a>00096 <span class="preprocessor">#endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>   <a class="code" href="a00023.html#910a0fdf1e7a70b08981dce14e86e291" title="Status returned by CTRL_ACCESS interfaces.">Ctrl_status</a> status;
<a name="l00098"></a>00098    
<a name="l00099"></a>00099    <span class="comment">// Possibility to ignore the disk check. Used to take time during multi read/write access</span>
<a name="l00100"></a>00100    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#6e59f1ec12b7954a956be7185df3ec05" title="Variables to enable/disable the disk check before each action on disk.">g_b_no_check_disk</a> )
<a name="l00101"></a>00101       <span class="keywordflow">return</span> TRUE;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="keywordflow">if</span>( 0xFF == <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l00104"></a>00104    {
<a name="l00105"></a>00105       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#cf37e5255ee1dbfaab77def32a7cbbef" title="Hardware driver error.">FS_ERR_HW</a>;
<a name="l00106"></a>00106       <span class="keywordflow">return</span> FALSE;                                <span class="comment">// No device selected</span>
<a name="l00107"></a>00107    }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109    <span class="keywordflow">for</span>( retry=0 ; retry&lt;100 ; retry++ )
<a name="l00110"></a>00110    {
<a name="l00111"></a>00111       <span class="comment">// Check device</span>
<a name="l00112"></a>00112       status = <a class="code" href="a00022.html#51555be425eeacfd88e603b9cba97049" title="Tests the memory state and initializes the memory if required.">mem_test_unit_ready</a>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> );
<a name="l00113"></a>00113       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8" title="Success, memory ready.">CTRL_GOOD</a>       == status )
<a name="l00114"></a>00114          <span class="keywordflow">return</span> TRUE;                              <span class="comment">// drive ready</span>
<a name="l00115"></a>00115 
<a name="l00116"></a>00116       <span class="comment">//* HERE error or state change</span>
<a name="l00117"></a>00117       <span class="comment">// Clean all navigator datas which use this device</span>
<a name="l00118"></a>00118       <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#74121fb3c8d3a1d018c911650e2ec920" title="FAT type (default = no mounted = FS_TYPE_FAT_UNM).">u8_type_fat</a> = <a class="code" href="a00025.html#429fbd0498704c3d5864877548040069" title="Partition not mounted.">FS_TYPE_FAT_UNM</a>; <span class="comment">// By default the fat isn't mounted</span>
<a name="l00119"></a>00119       <a class="code" href="a00025.html#55c673ca91c5301834a588e1d5a6515f">Fat_file_close</a>();                            <span class="comment">// By default the file is not open</span>
<a name="l00120"></a>00120 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>      <span class="keywordflow">for</span>( i=0 ; i!=(<a class="code" href="a00021.html#8ab6bd77e49639be7dc419bcf66bd73f" title="Maximal number of simultaneous navigators.">FS_NB_NAVIGATOR</a>-1) ; i++ )
<a name="l00122"></a>00122       {
<a name="l00123"></a>00123          <span class="keywordflow">if</span>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> == <a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l00124"></a>00124          {
<a name="l00125"></a>00125             <a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[i].<a class="code" href="a00011.html#74121fb3c8d3a1d018c911650e2ec920" title="FAT type (default = no mounted = FS_TYPE_FAT_UNM).">u8_type_fat</a>     = <a class="code" href="a00025.html#429fbd0498704c3d5864877548040069" title="Partition not mounted.">FS_TYPE_FAT_UNM</a>;   <span class="comment">// By default the fat isn't mounted</span>
<a name="l00126"></a>00126             <a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].<a class="code" href="a00010.html#316b7df1bf2c7e55453f17ad00290447" title="open mode of selected file">u8_open_mode</a>   = 0;                 <span class="comment">// By default the file is not open</span>
<a name="l00127"></a>00127          }
<a name="l00128"></a>00128       }
<a name="l00129"></a>00129 <span class="preprocessor">#endif</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span>      <span class="comment">// If the internal cache corresponding at device then clean it</span>
<a name="l00131"></a>00131       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> == <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a> )
<a name="l00132"></a>00132       {
<a name="l00133"></a>00133          <a class="code" href="a00024.html#961692919a93b6cb714ec2a3d57c0141" title="This function resets the sector cache.">fat_cache_reset</a>();
<a name="l00134"></a>00134       }
<a name="l00135"></a>00135       <a class="code" href="a00024.html#ecb0d4c200bed41b8bdcf671aa931a2a" title="This function resets the cluster list caches.">fat_cache_clusterlist_reset</a>();
<a name="l00136"></a>00136 
<a name="l00137"></a>00137       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#cf37e5255ee1dbfaab77def32a7cbbef" title="Hardware driver error.">FS_ERR_HW</a>;                     <span class="comment">// By default HW error</span>
<a name="l00138"></a>00138       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#910a0fdf1e7a70b08981dce14e86e291a647d0a662ac6400be3b843dfae52c65" title="Memory not initialized or changed.">CTRL_BUSY</a> == status )
<a name="l00139"></a>00139          <span class="keywordflow">continue</span>;                                 <span class="comment">// If device busy then retry</span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#910a0fdf1e7a70b08981dce14e86e29172ef3612d2c1df6f137934d4b89b18b7" title="Memory unplugged.">CTRL_NO_PRESENT</a> == status )
<a name="l00142"></a>00142          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#599d11cd249edc025b1a1fb514809db6" title="Device is not present.">FS_ERR_HW_NO_PRESENT</a>;       <span class="comment">// Update error flag</span>
<a name="l00143"></a>00143       <span class="keywordflow">break</span>;                                       <span class="comment">// FAIL or NOT PRESENT = fatal error = no retry</span>
<a name="l00144"></a>00144    }
<a name="l00145"></a>00145    <span class="keywordflow">return</span> FALSE;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 
<a name="l00154"></a><a class="code" href="a00025.html#8ee865aa4c51519c0d141f1f4559c72a">00154</a> Bool  <a class="code" href="a00024.html#8ee865aa4c51519c0d141f1f4559c72a" title="This function checks if the partition is mounted.">fat_check_mount</a>( <span class="keywordtype">void</span> )
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#eeec0bd6755a6be4c4dda2b4669eb0ae" title="This function checks device state.">fat_check_device</a>() )
<a name="l00157"></a>00157       <span class="keywordflow">return</span> FALSE;
<a name="l00158"></a>00158    <span class="keywordflow">if</span> (<a class="code" href="a00025.html#429fbd0498704c3d5864877548040069" title="Partition not mounted.">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#74121fb3c8d3a1d018c911650e2ec920" title="FAT type (default = no mounted = FS_TYPE_FAT_UNM).">u8_type_fat</a>)
<a name="l00159"></a>00159    {
<a name="l00160"></a>00160       <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#c0108ea608b547e8d3a405c70644c1e9" title="This function mounts a partition.">fat_mount</a>() )
<a name="l00161"></a>00161       {
<a name="l00162"></a>00162          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#1aeb93f5a9728927830dd999b9b0e720" title="The partition isn&amp;#39;t mounted.">FS_ERR_NO_MOUNT</a>;
<a name="l00163"></a>00163          <span class="keywordflow">return</span> FALSE;
<a name="l00164"></a>00164       }
<a name="l00165"></a>00165    }
<a name="l00166"></a>00166    <span class="keywordflow">return</span> TRUE;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 
<a name="l00175"></a><a class="code" href="a00025.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">00175</a> Bool  <a class="code" href="a00024.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0" title="This function checks if a file is not opened on current navigator.">fat_check_noopen</a>( <span class="keywordtype">void</span> )
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#eeec0bd6755a6be4c4dda2b4669eb0ae" title="This function checks device state.">fat_check_device</a>() )
<a name="l00178"></a>00178       <span class="keywordflow">return</span> TRUE;
<a name="l00179"></a>00179    <span class="keywordflow">if</span> (<a class="code" href="a00025.html#429fbd0498704c3d5864877548040069" title="Partition not mounted.">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#74121fb3c8d3a1d018c911650e2ec920" title="FAT type (default = no mounted = FS_TYPE_FAT_UNM).">u8_type_fat</a>)
<a name="l00180"></a>00180       <span class="keywordflow">return</span> TRUE;
<a name="l00181"></a>00181    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#9bce5b4def8042e051c97409568e0138">Fat_file_is_open</a>() )
<a name="l00182"></a>00182    {
<a name="l00183"></a>00183       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#498b273aa1304bf952cff68f0904e869" title="The navigation have already opened a file.">FS_ERR_TOO_FILE_OPEN</a>;  <span class="comment">// The navigation have already open a file</span>
<a name="l00184"></a>00184       <span class="keywordflow">return</span> FALSE;
<a name="l00185"></a>00185    }
<a name="l00186"></a>00186    <span class="keywordflow">return</span> TRUE;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 
<a name="l00195"></a><a class="code" href="a00025.html#4efc7734a340e899bb54506b277bb8c1">00195</a> Bool  <a class="code" href="a00024.html#4efc7734a340e899bb54506b277bb8c1" title="This function checks if a file is opened on current navigator.">fat_check_open</a>( <span class="keywordtype">void</span> )
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#683f625ba66d2777d10aa6cc7c7435d9">Fat_file_isnot_open</a>() )
<a name="l00198"></a>00198    {
<a name="l00199"></a>00199       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#ac3120e8423320b534f9ec08112ee8b9" title="No file is opened.">FS_ERR_FILE_NO_OPEN</a>;
<a name="l00200"></a>00200       <span class="keywordflow">return</span> FALSE;
<a name="l00201"></a>00201    }
<a name="l00202"></a>00202    <span class="keywordflow">return</span> TRUE;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 
<a name="l00211"></a><a class="code" href="a00025.html#909da9e84afbebf8ed5838cbe5002f60">00211</a> Bool  <a class="code" href="a00024.html#909da9e84afbebf8ed5838cbe5002f60" title="This function checks if a file is selected on current navigator.">fat_check_select</a>( <span class="keywordtype">void</span> )
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213    <span class="keywordflow">if</span> (<a class="code" href="a00025.html#2e16c6cfcb3174f7ad19ad3996a69ae7" title="Signal that a file entry isn&amp;#39;t selected.">FS_NO_SEL</a> == <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#9f50297ed427918e54da99b8c4fbaf04" title="Entry file position in directory (unit = FS_SIZE_FILE_ENTRY) (see value FS_NO_SEL...">u16_entry_pos_sel_file</a>)
<a name="l00214"></a>00214    {
<a name="l00215"></a>00215       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#231c28be4072acdd82517f3a24e2b245" title="There are no selected file.">FS_ERR_NO_FILE_SEL</a>;
<a name="l00216"></a>00216       <span class="keywordflow">return</span> FALSE;
<a name="l00217"></a>00217    }
<a name="l00218"></a>00218    <span class="keywordflow">return</span> TRUE;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00227"></a><a class="code" href="a00025.html#e9d0f61d0e7b29a4e8e9e95347194f21">00227</a> Bool  <a class="code" href="a00024.html#e9d0f61d0e7b29a4e8e9e95347194f21" title="This function checks if the partition is mounted and no file is opened.">fat_check_mount_noopen</a>( <span class="keywordtype">void</span> )
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#8ee865aa4c51519c0d141f1f4559c72a" title="This function checks if the partition is mounted.">fat_check_mount</a>() )
<a name="l00230"></a>00230       <span class="keywordflow">return</span> FALSE;
<a name="l00231"></a>00231    <span class="keywordflow">return</span> <a class="code" href="a00024.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0" title="This function checks if a file is not opened on current navigator.">fat_check_noopen</a>();
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 
<a name="l00240"></a><a class="code" href="a00025.html#003f1c81dcb2c7a95f191c30b8a4f258">00240</a> Bool  <a class="code" href="a00024.html#003f1c81dcb2c7a95f191c30b8a4f258" title="This function checks if the partition is mounted and if no file is opened and a file...">fat_check_mount_select_noopen</a>( <span class="keywordtype">void</span> )
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#8ee865aa4c51519c0d141f1f4559c72a" title="This function checks if the partition is mounted.">fat_check_mount</a>() )
<a name="l00243"></a>00243       <span class="keywordflow">return</span> FALSE;
<a name="l00244"></a>00244    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#909da9e84afbebf8ed5838cbe5002f60" title="This function checks if a file is selected on current navigator.">fat_check_select</a>() )
<a name="l00245"></a>00245       <span class="keywordflow">return</span> FALSE;
<a name="l00246"></a>00246    <span class="keywordflow">return</span> <a class="code" href="a00024.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0" title="This function checks if a file is not opened on current navigator.">fat_check_noopen</a>();
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 
<a name="l00255"></a><a class="code" href="a00025.html#0096f66037f89595dfccbca38ab795f8">00255</a> Bool  <a class="code" href="a00024.html#0096f66037f89595dfccbca38ab795f8" title="This function checks if the partition is mounted and if a file is opened.">fat_check_mount_select_open</a>( <span class="keywordtype">void</span> )
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#8ee865aa4c51519c0d141f1f4559c72a" title="This function checks if the partition is mounted.">fat_check_mount</a>() )
<a name="l00258"></a>00258       <span class="keywordflow">return</span> FALSE;
<a name="l00259"></a>00259    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#909da9e84afbebf8ed5838cbe5002f60" title="This function checks if a file is selected on current navigator.">fat_check_select</a>() )
<a name="l00260"></a>00260       <span class="keywordflow">return</span> FALSE;
<a name="l00261"></a>00261    <span class="keywordflow">return</span> <a class="code" href="a00024.html#4efc7734a340e899bb54506b277bb8c1" title="This function checks if a file is opened on current navigator.">fat_check_open</a>();
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 
<a name="l00270"></a><a class="code" href="a00025.html#47e29fedbed4084c9f8ec6f27b51015d">00270</a> Bool  <a class="code" href="a00024.html#47e29fedbed4084c9f8ec6f27b51015d" title="This function checks if the partition is mounted and if a file is selected.">fat_check_mount_select</a>( <span class="keywordtype">void</span> )
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#8ee865aa4c51519c0d141f1f4559c72a" title="This function checks if the partition is mounted.">fat_check_mount</a>() )
<a name="l00273"></a>00273       <span class="keywordflow">return</span> FALSE;
<a name="l00274"></a>00274    <span class="keywordflow">return</span> <a class="code" href="a00024.html#909da9e84afbebf8ed5838cbe5002f60" title="This function checks if a file is selected on current navigator.">fat_check_select</a>();
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 
<a name="l00283"></a><a class="code" href="a00025.html#2fb226027c5ea59f40c582737e5a44b9">00283</a> Bool  <a class="code" href="a00024.html#2fb226027c5ea59f40c582737e5a44b9" title="This function checks if the selected file entry is a file and not a directory.">fat_check_is_file</a>( <span class="keywordtype">void</span> )
<a name="l00284"></a>00284 {
<a name="l00285"></a>00285    <span class="keywordflow">if</span>( <a class="code" href="a00031.html#627f80804f90f766ed2cda3a012bcf66">Fat_is_not_a_file</a> )
<a name="l00286"></a>00286    {
<a name="l00287"></a>00287       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#d9116e06ad4be1ef2ff8e7cb649ccb90" title="The selected file entry isn&amp;#39;t a file.">FS_ERR_NO_FILE</a>;   <span class="comment">// It isn't a file, it is a directory or a volume id</span>
<a name="l00288"></a>00288       <span class="keywordflow">return</span> FALSE;
<a name="l00289"></a>00289    }
<a name="l00290"></a>00290    <span class="keywordflow">return</span> TRUE;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00299"></a><a class="code" href="a00025.html#920798e6366e8c3c408601c58fed4bb3">00299</a> <span class="preprocessor">U8    fat_get_nbpartition( void )</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span>{
<a name="l00301"></a>00301    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#eeec0bd6755a6be4c4dda2b4669eb0ae" title="This function checks device state.">fat_check_device</a>() )
<a name="l00302"></a>00302       <span class="keywordflow">return</span> 0;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="preprocessor">#warning this routine contains bug, rework it</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>   <span class="comment">// Read the first sector of drive</span>
<a name="l00306"></a>00306    <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a> = 0;
<a name="l00307"></a>00307    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ))
<a name="l00308"></a>00308       <span class="keywordflow">return</span> FALSE;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="comment">// Check PBR or MBR signature</span>
<a name="l00311"></a>00311    <span class="keywordflow">if</span> ( (<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[510] != <a class="code" href="a00025.html#36f09355f7020d410cb43695cab680fa">FS_BR_SIGNATURE_LOW</a>  )
<a name="l00312"></a>00312    &amp;&amp;   (<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[511] != <a class="code" href="a00025.html#b4cd4bfc6a5baebc1d25bbc5d5db2c15">FS_BR_SIGNATURE_HIGH</a> ) )
<a name="l00313"></a>00313    {
<a name="l00314"></a>00314       <span class="comment">// No MBR</span>
<a name="l00315"></a>00315       <span class="comment">// The sector, is it a PBR ?</span>
<a name="l00316"></a>00316       <span class="keywordflow">if</span> ( (<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[0] == 0xEB) &amp;&amp;          <span class="comment">// PBR Byte 0</span>
<a name="l00317"></a>00317            (<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[2] == 0x90) &amp;&amp;          <span class="comment">// PBR Byte 2</span>
<a name="l00318"></a>00318            ((<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[21] &amp; 0xF0) == 0xF0) ) <span class="comment">// PBR Byte 21 : Media byte</span>
<a name="l00319"></a>00319       {
<a name="l00320"></a>00320          <span class="keywordflow">return</span> 1;   <span class="comment">// No MBR but PBR exist then only one partition</span>
<a name="l00321"></a>00321       } <span class="keywordflow">else</span> {
<a name="l00322"></a>00322          <span class="keywordflow">return</span> 0;   <span class="comment">// No MBR and no PBR then no partition found</span>
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324    }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    number_part = 0;
<a name="l00327"></a>00327    <span class="keywordflow">while</span>( 1 )
<a name="l00328"></a>00328    {
<a name="l00329"></a>00329       <span class="comment">// The first sector must be a MBR, then check the partition entry in the MBR</span>
<a name="l00330"></a>00330       <span class="keywordflow">if</span> ( ((<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00025.html#70b90ba913c43a878e9b478de5d1b61c" title="Position (unit byte) in the MBR of a partition entry.">FS_MBR_OFFSET_PART_ENTRY</a>(number_part)+0] != FS_PARTITION_ACTIVE) &amp;&amp;
<a name="l00331"></a>00331             (<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00025.html#70b90ba913c43a878e9b478de5d1b61c" title="Position (unit byte) in the MBR of a partition entry.">FS_MBR_OFFSET_PART_ENTRY</a>(number_part)+0] != 0x00))
<a name="l00332"></a>00332       ||    (<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00025.html#70b90ba913c43a878e9b478de5d1b61c" title="Position (unit byte) in the MBR of a partition entry.">FS_MBR_OFFSET_PART_ENTRY</a>(number_part)+4] == 0x00) )
<a name="l00333"></a>00333       {
<a name="l00334"></a>00334          <span class="keywordflow">break</span>;
<a name="l00335"></a>00335       }
<a name="l00336"></a>00336       number_part++;
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338    <span class="keywordflow">return</span> number_part;
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 <span class="preprocessor">#endif</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>
<a name="l00342"></a>00342 
<a name="l00364"></a><a class="code" href="a00025.html#b08a718173c6b1a1966e6395801a32e7">00364</a> Bool  <a class="code" href="a00024.html#b08a718173c6b1a1966e6395801a32e7" title="This function gets or clears a cluster list.">fat_cluster_list</a>( U8 opt_action, Bool b_for_file )
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366    _MEM_TYPE_FAST_ U32 u32_tmp;
<a name="l00367"></a>00367    _MEM_TYPE_FAST_ U8 u8_cluster_status;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#89613ba21711697c707a3199bf93b9cf" title="File system error.">FS_ERR_FS</a>;      <span class="comment">// By default system error</span>
<a name="l00370"></a>00370 
<a name="l00371"></a>00371    <span class="keywordflow">if</span>(  <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a>
<a name="l00372"></a>00372    &amp;&amp;  (<a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action) )
<a name="l00373"></a>00373    {
<a name="l00374"></a>00374 <span class="preprocessor">#if (FSFEATURE_WRITE_COMPLET == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE_COMPLET) )</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>      <span class="comment">// Clear free space information storage in FAT32</span>
<a name="l00376"></a>00376       <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#9cf154ffe36bc2c00b1d589e523b449c" title="This function writes the space free number in selected FAT32 partition.">fat_write_fat32_FSInfo</a>( 0xFFFFFFFF ))
<a name="l00377"></a>00377          <span class="keywordflow">return</span> FALSE;
<a name="l00378"></a>00378 <span class="preprocessor">#else</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span>      <span class="keywordflow">return</span> FALSE;
<a name="l00380"></a>00380 <span class="preprocessor">#endif</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>   }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383    <span class="keywordflow">if</span> ( 0 == <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> )
<a name="l00384"></a>00384    {
<a name="l00385"></a>00385       <span class="comment">// Cluster list of root directory</span>
<a name="l00386"></a>00386       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action )
<a name="l00387"></a>00387          <span class="keywordflow">return</span> FALSE;           <span class="comment">// Impossible to erase ROOT DIR</span>
<a name="l00388"></a>00388 
<a name="l00389"></a>00389       <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> || <a class="code" href="a00025.html#2dcd74d640da1e20ad510413c9ef4c85">Is_fat16</a> )
<a name="l00390"></a>00390       {
<a name="l00391"></a>00391          <span class="comment">// For a FAT 12 &amp; 16, the root dir isn't a cluster list</span>
<a name="l00392"></a>00392          <span class="comment">// Check the position</span>
<a name="l00393"></a>00393          <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> &lt; <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#b26050633d0597af6c2c6abe9684481b" title="Root directory informations.">rootdir</a>.<a class="code" href="a00012.html#996b5fc79b7527c2b3dc3b34ed98f428" title="For FAT 12 &amp;amp; 16, it is a segment (no cluster list).">seg</a>.<a class="code" href="a00012.html#5e384bddb7393218e17f0329d1b8527f" title="Size of root (unit 512B).">u16_size</a> )
<a name="l00394"></a>00394          {
<a name="l00395"></a>00395             <span class="comment">// Compute the start address and the size</span>
<a name="l00396"></a>00396             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af1d8fda28bded48a54c7eab4d729618" title="FAT address (unit 512B).">u32_ptr_fat</a> + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#b26050633d0597af6c2c6abe9684481b" title="Root directory informations.">rootdir</a>.<a class="code" href="a00012.html#996b5fc79b7527c2b3dc3b34ed98f428" title="For FAT 12 &amp;amp; 16, it is a segment (no cluster list).">seg</a>.<a class="code" href="a00012.html#a17ca07269fcb28d77b14e5a67d56378" title="Offset between the beginning of FAT and the beginning of root dir (unit 512B).">u16_pos</a> + <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00397"></a>00397             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#b26050633d0597af6c2c6abe9684481b" title="Root directory informations.">rootdir</a>.<a class="code" href="a00012.html#996b5fc79b7527c2b3dc3b34ed98f428" title="For FAT 12 &amp;amp; 16, it is a segment (no cluster list).">seg</a>.<a class="code" href="a00012.html#5e384bddb7393218e17f0329d1b8527f" title="Size of root (unit 512B).">u16_size</a> - <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00398"></a>00398             <span class="keywordflow">return</span> TRUE;
<a name="l00399"></a>00399          } <span class="keywordflow">else</span> {
<a name="l00400"></a>00400             <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#e8798a89bfc4f49da50fc55b14a5b07f" title="The position is outside the cluster list.">FS_ERR_OUT_LIST</a>;
<a name="l00401"></a>00401             <span class="keywordflow">return</span> FALSE;        <span class="comment">// Position outside the root area</span>
<a name="l00402"></a>00402          }
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404       <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00405"></a>00405       {
<a name="l00406"></a>00406          <span class="comment">// For FAT 32, the root is a cluster list and the first cluster is reading during the mount</span>
<a name="l00407"></a>00407          <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#b26050633d0597af6c2c6abe9684481b" title="Root directory informations.">rootdir</a>.<a class="code" href="a00012.html#54d1e701d0705a2b2adb2b2cdc2e604b" title="For FAT32, the root directory is a cluster list.">u32_cluster</a>;
<a name="l00408"></a>00408       }
<a name="l00409"></a>00409    } <span class="keywordflow">else</span> {
<a name="l00410"></a>00410       <span class="comment">// It is the first cluster of a cluster list</span>
<a name="l00411"></a>00411       <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>;
<a name="l00412"></a>00412    }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    <span class="comment">// Management of cluster list caches</span>
<a name="l00415"></a>00415    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> != opt_action )
<a name="l00416"></a>00416    {
<a name="l00417"></a>00417       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#b4f9f4f20c7e1ef6fa76ddc52cdc54f1" title="This function searchs a cluster list in cluster list caches.">fat_cache_clusterlist_update_read</a>( b_for_file ) )
<a name="l00418"></a>00418          <span class="keywordflow">return</span> TRUE;            <span class="comment">// Segment found in cache</span>
<a name="l00419"></a>00419       <span class="comment">// Segment not found &amp; cache ready to update</span>
<a name="l00420"></a>00420    }<span class="keywordflow">else</span>{
<a name="l00421"></a>00421       <a class="code" href="a00024.html#ecb0d4c200bed41b8bdcf671aa931a2a" title="This function resets the cluster list caches.">fat_cache_clusterlist_reset</a>();   <span class="comment">// It is a clear action then clear cluster list caches</span>
<a name="l00422"></a>00422 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>      <a class="code" href="a00025.html#9503329592cf7484faf77ca95a6a21aa" title="This function clears the cache information about FAT modifications.">fat_clear_info_fat_mod</a>();        <span class="comment">// Init cache on fat modification range</span>
<a name="l00424"></a>00424 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>   }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    <span class="comment">// Init loop with a start segment no found</span>
<a name="l00428"></a>00428    MSB0( <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> ) = 0xFF;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430    <span class="comment">//**** Loop to read the cluster list</span>
<a name="l00431"></a>00431    <span class="keywordflow">while</span> ( 1 )
<a name="l00432"></a>00432    {
<a name="l00433"></a>00433       <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> &lt; <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a> )
<a name="l00434"></a>00434       {
<a name="l00435"></a>00435          <span class="comment">// The segment starts in this cluster</span>
<a name="l00436"></a>00436          <span class="comment">// Compute the sector address of this cluster</span>
<a name="l00437"></a>00437          <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = ((<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> - 2) * <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>)
<a name="l00438"></a>00438                            + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af1d8fda28bded48a54c7eab4d729618" title="FAT address (unit 512B).">u32_ptr_fat</a> + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#4666662ac4fa96c340a61e5fb786b83a" title="Offset between the beginning of FAT and the first cluster (unit 512B).">u32_offset_data</a> + <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440          <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> == opt_action )
<a name="l00441"></a>00441          {
<a name="l00442"></a>00442             <span class="comment">// Compute the maximum size</span>
<a name="l00443"></a>00443             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>-<a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00444"></a>00444             <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a>();
<a name="l00445"></a>00445             <span class="comment">// Send a size of one sector</span>
<a name="l00446"></a>00446             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = 1;
<a name="l00447"></a>00447             <span class="keywordflow">return</span> TRUE;
<a name="l00448"></a>00448          }
<a name="l00449"></a>00449          <span class="comment">// Update the segment size</span>
<a name="l00450"></a>00450          <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a> - LSB0( <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> );
<a name="l00451"></a>00451 
<a name="l00452"></a>00452          <span class="comment">// Take time, during read cluster list on FAT 16 &amp; 32</span>
<a name="l00453"></a>00453          <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == opt_action)
<a name="l00454"></a>00454          &amp;&amp;  (!<a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a>) )
<a name="l00455"></a>00455          {
<a name="l00456"></a>00456             <span class="comment">// Init loop with the current cluster</span>
<a name="l00457"></a>00457             u32_tmp = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>;
<a name="l00458"></a>00458             <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#1be84552293d174f534b2fb8d0a4e737" title="This function returns or modifys a cluster value in FAT.">fat_cluster_val</a>( <a class="code" href="a00025.html#087734ece5cae84508fd1fbe9414ad02">FS_CLUST_VAL_READ</a> ))
<a name="l00459"></a>00459                <span class="keywordflow">return</span> FALSE;
<a name="l00460"></a>00460             <span class="comment">// Read cluster list, while this one is continue</span>
<a name="l00461"></a>00461             <span class="keywordflow">while</span>(1)
<a name="l00462"></a>00462             {
<a name="l00463"></a>00463                <span class="keywordflow">if</span> ( (++<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>) != <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> )
<a name="l00464"></a>00464                {
<a name="l00465"></a>00465                   <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>--;                   <span class="comment">// Recompute previous value</span>
<a name="l00466"></a>00466                   u32_tmp = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> - u32_tmp; <span class="comment">// Compute the size of cluster list</span>
<a name="l00467"></a>00467                   <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> += u32_tmp * <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>;
<a name="l00468"></a>00468                   <span class="keywordflow">break</span>;
<a name="l00469"></a>00469                }
<a name="l00470"></a>00470                <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#e28958d1a5e3ed006edf937e6b7dacc7" title="This function is optimized to read a continue cluster list on FAT16 and FAT32.">fat_cluster_readnext</a>() )
<a name="l00471"></a>00471                   <span class="keywordflow">return</span> FALSE;
<a name="l00472"></a>00472             }
<a name="l00473"></a>00473          }
<a name="l00474"></a>00474       }
<a name="l00475"></a>00475       <span class="comment">// Get the cluster value</span>
<a name="l00476"></a>00476       <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#1be84552293d174f534b2fb8d0a4e737" title="This function returns or modifys a cluster value in FAT.">fat_cluster_val</a>( <a class="code" href="a00025.html#087734ece5cae84508fd1fbe9414ad02">FS_CLUST_VAL_READ</a> ))
<a name="l00477"></a>00477          <span class="keywordflow">return</span> FALSE;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479       <span class="comment">// Read and check the status of the new cluster</span>
<a name="l00480"></a>00480       u8_cluster_status = <a class="code" href="a00024.html#4010dc2ad42864603bb81a41b485d346" title="This function checks the cluster value.">fat_checkcluster</a>();
<a name="l00481"></a>00481       <span class="keywordflow">if</span> (<a class="code" href="a00025.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a> == u8_cluster_status)
<a name="l00482"></a>00482          <span class="keywordflow">return</span> FALSE; <span class="comment">// error, end of cluster list</span>
<a name="l00483"></a>00483 
<a name="l00484"></a>00484       <span class="keywordflow">if</span> (0xFF == MSB0(<a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>))
<a name="l00485"></a>00485       {
<a name="l00486"></a>00486          <span class="comment">// The beginning of the segment isn't found</span>
<a name="l00487"></a>00487          <span class="keywordflow">if</span> (<a class="code" href="a00025.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a> == u8_cluster_status)
<a name="l00488"></a>00488          {
<a name="l00489"></a>00489             u32_tmp = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;       <span class="comment">// Save number of sector remaining</span>
<a name="l00490"></a>00490 
<a name="l00491"></a>00491             <span class="comment">// Compute the sector address of this last cluster to take time during a futur request with the same cluster list</span>
<a name="l00492"></a>00492             <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a> -= <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00493"></a>00493             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = ((<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> - 2) * <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>)
<a name="l00494"></a>00494                               + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af1d8fda28bded48a54c7eab4d729618" title="FAT address (unit 512B).">u32_ptr_fat</a> + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#4666662ac4fa96c340a61e5fb786b83a" title="Offset between the beginning of FAT and the first cluster (unit 512B).">u32_offset_data</a>;
<a name="l00495"></a>00495             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>;
<a name="l00496"></a>00496             <span class="keywordflow">if</span> (<a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> != opt_action)
<a name="l00497"></a>00497                <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a>();
<a name="l00498"></a>00498 
<a name="l00499"></a>00499             <span class="comment">// The position is outside the cluster list</span>
<a name="l00500"></a>00500             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>; <span class="comment">// Send the last cluster value</span>
<a name="l00501"></a>00501             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = u32_tmp;       <span class="comment">// Restore number of sector remaining</span>
<a name="l00502"></a>00502             <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#e8798a89bfc4f49da50fc55b14a5b07f" title="The position is outside the cluster list.">FS_ERR_OUT_LIST</a>;
<a name="l00503"></a>00503             <span class="keywordflow">return</span> FALSE;
<a name="l00504"></a>00504          }
<a name="l00505"></a>00505          <span class="comment">// Good cluster then continue</span>
<a name="l00506"></a>00506          <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> -= <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>;
<a name="l00507"></a>00507 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action)
<a name="l00509"></a>00509          {
<a name="l00510"></a>00510             <span class="keywordflow">if</span>( <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> == 0)
<a name="l00511"></a>00511             {
<a name="l00512"></a>00512                <span class="comment">// At cluster position, set the flag end of cluster list</span>
<a name="l00513"></a>00513                <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a>; <span class="comment">// Save the next cluster</span>
<a name="l00514"></a>00514                <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> = <a class="code" href="a00025.html#6a0f491ab351899993a4171f5ff526f3">FS_CLUST_VAL_EOL</a>;
<a name="l00515"></a>00515                <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#1be84552293d174f534b2fb8d0a4e737" title="This function returns or modifys a cluster value in FAT.">fat_cluster_val</a>( <a class="code" href="a00025.html#c11d0331723bc237aac4d6c7a4fe7496">FS_CLUST_VAL_WRITE</a> ))
<a name="l00516"></a>00516                   <span class="keywordflow">return</span> FALSE;
<a name="l00517"></a>00517                <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>; <span class="comment">// Resotre the next cluster</span>
<a name="l00518"></a>00518                <span class="comment">// !!!! It isn't necessary to reinit MSB0( fs_g_seg.u32_addr ) to 0xFF,</span>
<a name="l00519"></a>00519                <span class="comment">// !!!! fs_g_seg.u32_addr will be modified at the beginning of main loop</span>
<a name="l00520"></a>00520             }
<a name="l00521"></a>00521          }
<a name="l00522"></a>00522 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>      }
<a name="l00524"></a>00524       <span class="keywordflow">else</span>
<a name="l00525"></a>00525       {
<a name="l00526"></a>00526          <span class="comment">// The beginning of segment is found</span>
<a name="l00527"></a>00527          <span class="keywordflow">if</span> (<a class="code" href="a00025.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == opt_action)
<a name="l00528"></a>00528          {
<a name="l00529"></a>00529             <span class="keywordflow">if</span> ( (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>+1) != <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> )
<a name="l00530"></a>00530             {
<a name="l00531"></a>00531                <span class="comment">// The cluster is not a continue cluster or a invalid cluster</span>
<a name="l00532"></a>00532                <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a>();
<a name="l00533"></a>00533                <span class="keywordflow">return</span> TRUE;                              <span class="comment">// End of segment</span>
<a name="l00534"></a>00534             }
<a name="l00535"></a>00535          }
<a name="l00536"></a>00536 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action)
<a name="l00538"></a>00538          {
<a name="l00539"></a>00539             <span class="comment">//** Clear cluster position</span>
<a name="l00540"></a>00540             <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a>;    <span class="comment">// Save the next cluster</span>
<a name="l00541"></a>00541             <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> = 0;                    <span class="comment">// by default free cluster</span>
<a name="l00542"></a>00542             <span class="comment">// If it is the first cluster (fs_g_seg.u32_size_or_pos &lt;= fs_g_nav.u8_BPB_SecPerClus)</span>
<a name="l00543"></a>00543             <span class="comment">// and doesn't start at the beginning of cluster (fs_g_seg.u32_size_or_pos != fs_g_nav.u8_BPB_SecPerClus)</span>
<a name="l00544"></a>00544             <span class="keywordflow">if</span> (<a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> &lt; <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>)
<a name="l00545"></a>00545             {
<a name="l00546"></a>00546                <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> = <a class="code" href="a00025.html#6a0f491ab351899993a4171f5ff526f3">FS_CLUST_VAL_EOL</a>;  <span class="comment">// End of cluster list allocated</span>
<a name="l00547"></a>00547             }
<a name="l00548"></a>00548             <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#1be84552293d174f534b2fb8d0a4e737" title="This function returns or modifys a cluster value in FAT.">fat_cluster_val</a>( <a class="code" href="a00025.html#c11d0331723bc237aac4d6c7a4fe7496">FS_CLUST_VAL_WRITE</a> ))
<a name="l00549"></a>00549                <span class="keywordflow">return</span> FALSE;
<a name="l00550"></a>00550             <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>;    <span class="comment">// Resotre the next cluster</span>
<a name="l00551"></a>00551             <span class="comment">// !!!! It isn't necessary to reinit MSB0( fs_g_seg.u32_addr ) at 0xFF,</span>
<a name="l00552"></a>00552             <span class="comment">// !!!! because it isn't possible that MSB0( fs_g_cluster.val ) = 0xFF.</span>
<a name="l00553"></a>00553          }
<a name="l00554"></a>00554 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>
<a name="l00556"></a>00556          <span class="comment">// Check the end of cluster list</span>
<a name="l00557"></a>00557          <span class="keywordflow">if</span> (<a class="code" href="a00025.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a> == u8_cluster_status)
<a name="l00558"></a>00558          {
<a name="l00559"></a>00559 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action)
<a name="l00561"></a>00561             {
<a name="l00562"></a>00562                <span class="keywordflow">return</span> <a class="code" href="a00025.html#8145cff91620fc1b70aa0eef5750db72" title="This function copys the modifications of the first FAT to the second FAT.">fat_update_fat2</a>();
<a name="l00563"></a>00563             }
<a name="l00564"></a>00564 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span>            <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a>();
<a name="l00566"></a>00566             <span class="keywordflow">return</span> TRUE; <span class="comment">// End of segment</span>
<a name="l00567"></a>00567          }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569          <span class="comment">// Update the segment size</span>
<a name="l00570"></a>00570          <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> += <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>;
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572       <span class="comment">// HERE, Continue to read the cluster list</span>
<a name="l00573"></a>00573       <span class="comment">// The next cluster is the value of previous cluster</span>
<a name="l00574"></a>00574       <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a>;
<a name="l00575"></a>00575    }  <span class="comment">// End of main loop</span>
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00581"></a><a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">00581</a> _MEM_TYPE_FAST_ U16   <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 
<a name="l00603"></a><a class="code" href="a00025.html#1be84552293d174f534b2fb8d0a4e737">00603</a> Bool  <a class="code" href="a00024.html#1be84552293d174f534b2fb8d0a4e737" title="This function returns or modifys a cluster value in FAT.">fat_cluster_val</a>( Bool b_mode )
<a name="l00604"></a>00604 {
<a name="l00605"></a>00605    _MEM_TYPE_FAST_ U16   u16_offset_fat;
<a name="l00606"></a>00606    _MEM_TYPE_FAST_ U8    u8_data1, u8_data2;
<a name="l00607"></a>00607 <span class="preprocessor">#define  u8_data3    (LSB(u16_offset_fat)) // Manual overlay</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span><span class="preprocessor">#define  u8_data4    (MSB(u16_offset_fat)) // Manual overlay</span>
<a name="l00609"></a>00609 <span class="preprocessor"></span>   _MEM_TYPE_FAST_ <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> u8_ptr_cluster;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611    <span class="comment">//**** Compute the cluster position in FAT (sector address &amp; position in sector)</span>
<a name="l00612"></a>00612    <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00613"></a>00613    {
<a name="l00614"></a>00614       <span class="comment">// FAT 32</span>
<a name="l00615"></a>00615       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.pos * 4 / FS_CACHE_SIZE;</span>
<a name="l00616"></a>00616       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.pos / 128</span>
<a name="l00617"></a>00617       u16_offset_fat = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> &gt;&gt; (8-1);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos * 4) % FS_CACHE_SIZE;</span>
<a name="l00620"></a>00620       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos % 128) * 4</span>
<a name="l00621"></a>00621       <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = ((U16)(LSB0(<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>) &amp; 0x7F))&lt;&lt; 2;
<a name="l00622"></a>00622    }
<a name="l00623"></a>00623    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#2dcd74d640da1e20ad510413c9ef4c85">Is_fat16</a> )
<a name="l00624"></a>00624    {
<a name="l00625"></a>00625       <span class="comment">// FAT 16</span>
<a name="l00626"></a>00626       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.u32_pos * 2 / FS_CACHE_SIZE = fs_g_cluster.u32_pos / 256;</span>
<a name="l00627"></a>00627       u16_offset_fat = LSB1(<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>);
<a name="l00628"></a>00628       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos * 2) % FS_CACHE_SIZE;</span>
<a name="l00629"></a>00629       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos % 256) * 2</span>
<a name="l00630"></a>00630       <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = ((U16)LSB0(<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>)) &lt;&lt;1;
<a name="l00631"></a>00631    }
<a name="l00632"></a>00632    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00633"></a>00633    {
<a name="l00634"></a>00634       <span class="comment">// FAT 12</span>
<a name="l00635"></a>00635       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = fs_g_cluster.u32_pos + (fs_g_cluster.u32_pos/ 2)</span>
<a name="l00636"></a>00636       <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = (U16)<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> + ((U16)<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> &gt;&gt;1);
<a name="l00637"></a>00637       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.u32_pos / FS_CACHE_SIZE</span>
<a name="l00638"></a>00638       u16_offset_fat = MSB(<a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>) &gt;&gt; 1;
<a name="l00639"></a>00639       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = fs_g_u16_pos_fat % FS_CACHE_SIZE</span>
<a name="l00640"></a>00640       MSB( <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> ) &amp;= 0x01;
<a name="l00641"></a>00641    }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00644"></a>00644 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (b_mode)
<a name="l00645"></a>00645    {
<a name="l00646"></a>00646       <span class="comment">// Update information about FAT modification</span>
<a name="l00647"></a>00647       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#b55b94c50b63cf8b83e2afcf2e0c2981" title="Offset (unit 512B) in fat of the first sector (unit 512B).">fs_g_u16_first_mod_fat</a> &gt; u16_offset_fat )
<a name="l00648"></a>00648       {
<a name="l00649"></a>00649          <a class="code" href="a00025.html#b55b94c50b63cf8b83e2afcf2e0c2981" title="Offset (unit 512B) in fat of the first sector (unit 512B).">fs_g_u16_first_mod_fat</a> = u16_offset_fat;
<a name="l00650"></a>00650       }
<a name="l00651"></a>00651       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#e8c6fce6d75eb9ddbf1e63e46659e9cc" title="Offset (unit 512B) in fat of the last sector (unit 512B).">fs_g_u16_last_mod_fat</a> &lt; u16_offset_fat )
<a name="l00652"></a>00652       {
<a name="l00653"></a>00653          <a class="code" href="a00025.html#e8c6fce6d75eb9ddbf1e63e46659e9cc" title="Offset (unit 512B) in fat of the last sector (unit 512B).">fs_g_u16_last_mod_fat</a> = u16_offset_fat;
<a name="l00654"></a>00654       }
<a name="l00655"></a>00655       <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00656"></a>00656       {  <span class="comment">// A cluster may be stored on two sectors</span>
<a name="l00657"></a>00657          <span class="keywordflow">if</span>( <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> == (<a class="code" href="a00025.html#1f24fc24a15f2e52ecae58ae2d5dfbfc">FS_CACHE_SIZE</a>-1) )
<a name="l00658"></a>00658          {  <span class="comment">// Count the next FAT sector</span>
<a name="l00659"></a>00659             <span class="keywordflow">if</span>( <a class="code" href="a00025.html#e8c6fce6d75eb9ddbf1e63e46659e9cc" title="Offset (unit 512B) in fat of the last sector (unit 512B).">fs_g_u16_last_mod_fat</a> &lt; (u16_offset_fat+1) )
<a name="l00660"></a>00660             {
<a name="l00661"></a>00661                <a class="code" href="a00025.html#e8c6fce6d75eb9ddbf1e63e46659e9cc" title="Offset (unit 512B) in fat of the last sector (unit 512B).">fs_g_u16_last_mod_fat</a> = (u16_offset_fat+1);
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663          }
<a name="l00664"></a>00664       }
<a name="l00665"></a>00665    }
<a name="l00666"></a>00666 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span>
<a name="l00668"></a>00668    <span class="comment">//**** Read cluster sector in FAT</span>
<a name="l00669"></a>00669    <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af1d8fda28bded48a54c7eab4d729618" title="FAT address (unit 512B).">u32_ptr_fat</a> + u16_offset_fat;   <span class="comment">// Computed logical sector address</span>
<a name="l00670"></a>00670    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ))
<a name="l00671"></a>00671       <span class="keywordflow">return</span> FALSE;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673    <span class="comment">// Read cluster information</span>
<a name="l00674"></a>00674    u8_ptr_cluster = &amp;<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>];
<a name="l00675"></a>00675    u8_data1 = u8_ptr_cluster[0];
<a name="l00676"></a>00676    <span class="comment">// Remark: if (fs_g_u16_pos_fat+1)=512 then it isn't a mistake, because this value will be erase in next lines</span>
<a name="l00677"></a>00677    u8_data2 = u8_ptr_cluster[1];
<a name="l00678"></a>00678    <a class="code" href="a00024.html#6b0f192ee05f7d19f1372a8a1fb514bc">u8_data3</a> = u8_ptr_cluster[2];
<a name="l00679"></a>00679    <a class="code" href="a00024.html#4d26b9400e3057b9cfde8d083a0049e6">u8_data4</a> = u8_ptr_cluster[3];
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00682"></a>00682    {   <span class="comment">// A cluster may be stored on two sectors</span>
<a name="l00683"></a>00683       <span class="keywordflow">if</span>(  <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> == (<a class="code" href="a00025.html#1f24fc24a15f2e52ecae58ae2d5dfbfc">FS_CACHE_SIZE</a>-1) )
<a name="l00684"></a>00684       {  <span class="comment">// Go to next sector</span>
<a name="l00685"></a>00685          <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a>++;
<a name="l00686"></a>00686          <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ))
<a name="l00687"></a>00687            <span class="keywordflow">return</span> FALSE;
<a name="l00688"></a>00688          u8_data2 = <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[0];
<a name="l00689"></a>00689       }
<a name="l00690"></a>00690    }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692    <span class="keywordflow">if</span> (FALSE == b_mode)
<a name="l00693"></a>00693    {
<a name="l00694"></a>00694       <span class="comment">//**** Read the cluster value</span>
<a name="l00695"></a>00695       LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = u8_data1;  <span class="comment">// FAT 12,16,32</span>
<a name="l00696"></a>00696       LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = u8_data2;  <span class="comment">// FAT 12,16,32</span>
<a name="l00697"></a>00697 
<a name="l00698"></a>00698       <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00699"></a>00699       {  <span class="comment">// FAT 32</span>
<a name="l00700"></a>00700          LSB2( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = <a class="code" href="a00024.html#6b0f192ee05f7d19f1372a8a1fb514bc">u8_data3</a>;
<a name="l00701"></a>00701          LSB3( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = <a class="code" href="a00024.html#4d26b9400e3057b9cfde8d083a0049e6">u8_data4</a> &amp; 0x0F; <span class="comment">// The high 4 bits are reserved</span>
<a name="l00702"></a>00702       }
<a name="l00703"></a>00703       <span class="keywordflow">else</span>
<a name="l00704"></a>00704       {  <span class="comment">// FAT 12 &amp; 16 don't use the high bytes</span>
<a name="l00705"></a>00705          LSB2( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = 0;
<a name="l00706"></a>00706          LSB3( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = 0;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708          <span class="comment">// FAT 12 translate 16bits value to 12bits</span>
<a name="l00709"></a>00709          <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00710"></a>00710          {
<a name="l00711"></a>00711             <span class="keywordflow">if</span> ( 0x01 &amp; LSB0(<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>) )
<a name="l00712"></a>00712             {  <span class="comment">// Readed cluster is ODD</span>
<a name="l00713"></a>00713                LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = (LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) &lt;&lt;4 ) + (LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) &gt;&gt;4 );
<a name="l00714"></a>00714                LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) =  LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) &gt;&gt;4 ;
<a name="l00715"></a>00715             }
<a name="l00716"></a>00716             <span class="keywordflow">else</span>
<a name="l00717"></a>00717             {  <span class="comment">// Readed cluster is EVEN</span>
<a name="l00718"></a>00718                LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) &amp;= 0x0F;
<a name="l00719"></a>00719             }
<a name="l00720"></a>00720          }
<a name="l00721"></a>00721       }
<a name="l00722"></a>00722    } <span class="keywordflow">else</span> {
<a name="l00723"></a>00723 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span>      <span class="comment">//**** Write the cluster value</span>
<a name="l00725"></a>00725       <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00726"></a>00726       {
<a name="l00727"></a>00727          <span class="comment">// FAT 12, translate cluster value</span>
<a name="l00728"></a>00728          <span class="keywordflow">if</span> ( 0x01 &amp; LSB0(<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>) )
<a name="l00729"></a>00729          {  <span class="comment">// Cluster writing is ODD</span>
<a name="l00730"></a>00730             u8_data1 = (u8_data1 &amp; 0x0F) + (LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> )&lt;&lt;4);
<a name="l00731"></a>00731             u8_data2 = (LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> )&lt;&lt;4) + (LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> )&gt;&gt;4) ;
<a name="l00732"></a>00732          } <span class="keywordflow">else</span> {
<a name="l00733"></a>00733             <span class="comment">// Cluster writing is EVEN</span>
<a name="l00734"></a>00734             u8_data1 = LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> );
<a name="l00735"></a>00735             u8_data2 = (u8_data2 &amp; 0xF0) + (LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) &amp; 0x0F) ;
<a name="l00736"></a>00736          }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738          <span class="comment">// A cluster may be stored on two sectors</span>
<a name="l00739"></a>00739          <span class="keywordflow">if</span>( <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> == (<a class="code" href="a00025.html#1f24fc24a15f2e52ecae58ae2d5dfbfc">FS_CACHE_SIZE</a>-1) )
<a name="l00740"></a>00740          {
<a name="l00741"></a>00741             <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[0] = u8_data2;
<a name="l00742"></a>00742             <a class="code" href="a00024.html#45c0f16885c9e414ddb4b5afaa1cde34" title="This function sets a flag to signal that sector cache is modified.">fat_cache_mark_sector_as_dirty</a>();
<a name="l00743"></a>00743             <span class="comment">// Go to previous sector</span>
<a name="l00744"></a>00744             <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a>--;
<a name="l00745"></a>00745             <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ))
<a name="l00746"></a>00746               <span class="keywordflow">return</span> FALSE;
<a name="l00747"></a>00747             <span class="comment">// Modify the previous sector</span>
<a name="l00748"></a>00748             <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[ <a class="code" href="a00025.html#1f24fc24a15f2e52ecae58ae2d5dfbfc">FS_CACHE_SIZE</a>-1 ] = u8_data1;
<a name="l00749"></a>00749             <a class="code" href="a00024.html#45c0f16885c9e414ddb4b5afaa1cde34" title="This function sets a flag to signal that sector cache is modified.">fat_cache_mark_sector_as_dirty</a>();
<a name="l00750"></a>00750             <span class="keywordflow">return</span> TRUE;
<a name="l00751"></a>00751          }
<a name="l00752"></a>00752       }
<a name="l00753"></a>00753       <span class="keywordflow">else</span>
<a name="l00754"></a>00754       {
<a name="l00755"></a>00755          <span class="comment">// FAT 16 &amp; 32</span>
<a name="l00756"></a>00756          u8_data1 = LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> );
<a name="l00757"></a>00757          u8_data2 = LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> );
<a name="l00758"></a>00758          <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00759"></a>00759          {  <span class="comment">// FAT 32</span>
<a name="l00760"></a>00760             u8_ptr_cluster[2] = LSB2( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> );
<a name="l00761"></a>00761             u8_ptr_cluster[3] = LSB3( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) + (<a class="code" href="a00024.html#4d26b9400e3057b9cfde8d083a0049e6">u8_data4</a> &amp; 0xF0); <span class="comment">// The high 4 bits are reserved</span>
<a name="l00762"></a>00762          }
<a name="l00763"></a>00763       }
<a name="l00764"></a>00764       <span class="comment">// Here for FAT 32, 16 &amp; 12 (only if the cluster values are in the same sector)</span>
<a name="l00765"></a>00765       u8_ptr_cluster[0] = u8_data1;
<a name="l00766"></a>00766       u8_ptr_cluster[1] = u8_data2;
<a name="l00767"></a>00767       <a class="code" href="a00024.html#45c0f16885c9e414ddb4b5afaa1cde34" title="This function sets a flag to signal that sector cache is modified.">fat_cache_mark_sector_as_dirty</a>();
<a name="l00768"></a>00768 <span class="preprocessor">#else</span>
<a name="l00769"></a>00769 <span class="preprocessor"></span>      <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#d85516645a3ffadb77b948fd6d5bcb08" title="This command is not supported.">FS_ERR_COMMAND</a>;
<a name="l00770"></a>00770       <span class="keywordflow">return</span> FALSE;
<a name="l00771"></a>00771 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span>   }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774    <span class="keywordflow">return</span> TRUE;
<a name="l00775"></a>00775 <span class="preprocessor">#undef  u8_data3    // end of Manual overlay</span>
<a name="l00776"></a>00776 <span class="preprocessor"></span><span class="preprocessor">#undef  u8_data4    // end of Manual overlay</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>}
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 
<a name="l00798"></a><a class="code" href="a00025.html#e28958d1a5e3ed006edf937e6b7dacc7">00798</a> Bool  <a class="code" href="a00024.html#e28958d1a5e3ed006edf937e6b7dacc7" title="This function is optimized to read a continue cluster list on FAT16 and FAT32.">fat_cluster_readnext</a>( <span class="keywordtype">void</span> )
<a name="l00799"></a>00799 {
<a name="l00800"></a>00800    <span class="comment">// Compute the next cluster position in FAT</span>
<a name="l00801"></a>00801    <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00802"></a>00802    {
<a name="l00803"></a>00803       <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> += 4;
<a name="l00804"></a>00804    }<span class="keywordflow">else</span>{
<a name="l00805"></a>00805       <span class="comment">// Is_fat16</span>
<a name="l00806"></a>00806       <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> += 2;
<a name="l00807"></a>00807    }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809    <span class="comment">// Check if next cluster is in internal cache</span>
<a name="l00810"></a>00810    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#1f24fc24a15f2e52ecae58ae2d5dfbfc">FS_CACHE_SIZE</a> == <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> )
<a name="l00811"></a>00811    {
<a name="l00812"></a>00812       <span class="comment">// Update cache</span>
<a name="l00813"></a>00813       <a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = 0;
<a name="l00814"></a>00814       <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a>++;
<a name="l00815"></a>00815       <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ))
<a name="l00816"></a>00816          <span class="keywordflow">return</span> FALSE;
<a name="l00817"></a>00817    }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819    <span class="comment">//**** Read the cluster value</span>
<a name="l00820"></a>00820    LSB0( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+0];  <span class="comment">// FAT 16,32</span>
<a name="l00821"></a>00821    LSB1( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+1];  <span class="comment">// FAT 16,32</span>
<a name="l00822"></a>00822 
<a name="l00823"></a>00823    <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00824"></a>00824    {  <span class="comment">// FAT 32</span>
<a name="l00825"></a>00825       LSB2( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+2];
<a name="l00826"></a>00826       LSB3( <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> ) = <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[<a class="code" href="a00024.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+3];
<a name="l00827"></a>00827    }
<a name="l00828"></a>00828    <span class="keywordflow">return</span> TRUE;
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 
<a name="l00845"></a><a class="code" href="a00025.html#4010dc2ad42864603bb81a41b485d346">00845</a> U8    <a class="code" href="a00024.html#4010dc2ad42864603bb81a41b485d346" title="This function checks the cluster value.">fat_checkcluster</a>( <span class="keywordtype">void</span> )
<a name="l00846"></a>00846 {
<a name="l00847"></a>00847   <span class="keywordflow">if</span> ( !<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> )
<a name="l00848"></a>00848     <span class="keywordflow">return</span> <a class="code" href="a00025.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a>;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850   <span class="comment">// Cluster bad if (FAT12 == 0x0FF7) (FAT16 == 0xFFF7) (FAT32 == 0x0FFFFFF7)</span>
<a name="l00851"></a>00851   <span class="comment">// Last cluster if (FAT12 &gt; 0x0FF7) (FAT16 &gt; 0xFFF7) (FAT32 &gt; 0x0FFFFFF7)</span>
<a name="l00852"></a>00852   <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00853"></a>00853   {
<a name="l00854"></a>00854     <span class="keywordflow">if</span> (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> &gt;= 0x0FFFFFF8)
<a name="l00855"></a>00855       <span class="keywordflow">return</span> <a class="code" href="a00025.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a>;
<a name="l00856"></a>00856     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> == 0x0FFFFFF7)
<a name="l00857"></a>00857       <span class="keywordflow">return</span> <a class="code" href="a00025.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a>;
<a name="l00858"></a>00858   }
<a name="l00859"></a>00859   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#2dcd74d640da1e20ad510413c9ef4c85">Is_fat16</a> )
<a name="l00860"></a>00860   {
<a name="l00861"></a>00861     <span class="keywordflow">if</span> (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> &gt;= 0xFFF8)
<a name="l00862"></a>00862       <span class="keywordflow">return</span> <a class="code" href="a00025.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a>;
<a name="l00863"></a>00863     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> == 0xFFF7)
<a name="l00864"></a>00864       <span class="keywordflow">return</span> <a class="code" href="a00025.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a>;
<a name="l00865"></a>00865   }
<a name="l00866"></a>00866   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00867"></a>00867   {
<a name="l00868"></a>00868     <span class="keywordflow">if</span> (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> &gt;= 0xFF8)
<a name="l00869"></a>00869       <span class="keywordflow">return</span> <a class="code" href="a00025.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a>;
<a name="l00870"></a>00870     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#4f323a1ec38e3c0f1b57bf4fe07842b7" title="cluster value">u32_val</a> == 0xFF7)
<a name="l00871"></a>00871       <span class="keywordflow">return</span> <a class="code" href="a00025.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a>;
<a name="l00872"></a>00872   }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874   <span class="keywordflow">return</span> <a class="code" href="a00025.html#e9f7cc865270a55859b36205dc45b284">FS_CLUS_OK</a>;
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00879"></a>00879 
<a name="l00882"></a><a class="code" href="a00025.html#ecb0d4c200bed41b8bdcf671aa931a2a">00882</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#ecb0d4c200bed41b8bdcf671aa931a2a" title="This function resets the cluster list caches.">fat_cache_clusterlist_reset</a>( <span class="keywordtype">void</span> )
<a name="l00883"></a>00883 {
<a name="l00884"></a>00884    U8 u8_i;
<a name="l00885"></a>00885    <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>=0;
<a name="l00886"></a>00886    <span class="keywordflow">for</span>( u8_i=0; u8_i&lt;(<a class="code" href="a00021.html#ee9842c6b2f49d1bca72d0ad56e97502" title="Number of caches used to store a cluster list of files (interesting in case of many...">FS_NB_CACHE_CLUSLIST</a>*2); u8_i++ )
<a name="l00887"></a>00887    {
<a name="l00888"></a>00888       <span class="comment">// The cache list is splited in two cache (file cluster list and directory cluster list)</span>
<a name="l00889"></a>00889       <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#1826ec47ceec3f316fb4af191b919998" title="Signal a cluster cache from file cluster list or directory cluster list.">b_cache_file</a> = (u8_i&lt;<a class="code" href="a00021.html#ee9842c6b2f49d1bca72d0ad56e97502" title="Number of caches used to store a cluster list of files (interesting in case of many...">FS_NB_CACHE_CLUSLIST</a>)?TRUE:FALSE;
<a name="l00890"></a>00890       <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#9fbad8d6dc29d31a77b92c759ecfeba8" title="LUN of cluster list.">u8_lun</a> = 0xFF;
<a name="l00891"></a>00891       <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#a91792be887473384687bac546fae6bb" title="Cache level, 0 for the last used and up to FS_NB_CACHE_CLUSLIST-1 for the old access...">u8_level_use</a> = 0xFF;
<a name="l00892"></a>00892    }
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 
<a name="l00900"></a><a class="code" href="a00024.html#98a226b82d5df9c085d050fb341d8c6c">00900</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#98a226b82d5df9c085d050fb341d8c6c" title="This function initializes a cache in cluster list caches.">fat_cache_clusterlist_update_start</a>( Bool b_for_file )
<a name="l00901"></a>00901 {
<a name="l00902"></a>00902    <span class="comment">// Get the OLD cache (=max level used)</span>
<a name="l00903"></a>00903    U8 u8_i;
<a name="l00904"></a>00904    <span class="keywordflow">for</span>( u8_i=0; u8_i&lt;((<a class="code" href="a00021.html#ee9842c6b2f49d1bca72d0ad56e97502" title="Number of caches used to store a cluster list of files (interesting in case of many...">FS_NB_CACHE_CLUSLIST</a>*2)-1); u8_i++ ) <span class="comment">// (FS_NB_CACHE_CLUSLIST*2)-1, in case of error</span>
<a name="l00905"></a>00905    {
<a name="l00906"></a>00906       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].b_cache_file == b_for_file )
<a name="l00907"></a>00907       {
<a name="l00908"></a>00908 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00909"></a>00909 <span class="preprocessor"></span>         <span class="keywordflow">if</span>( (<a class="code" href="a00021.html#ee9842c6b2f49d1bca72d0ad56e97502" title="Number of caches used to store a cluster list of files (interesting in case of many...">FS_NB_CACHE_CLUSLIST</a>-2) &lt; <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#a91792be887473384687bac546fae6bb" title="Cache level, 0 for the last used and up to FS_NB_CACHE_CLUSLIST-1 for the old access...">u8_level_use</a> )
<a name="l00910"></a>00910 #endif
<a name="l00911"></a>00911             <span class="keywordflow">break</span>;
<a name="l00912"></a>00912       }
<a name="l00913"></a>00913    }
<a name="l00914"></a>00914    <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a> = u8_i;
<a name="l00915"></a>00915    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#1826ec47ceec3f316fb4af191b919998" title="Signal a cluster cache from file cluster list or directory cluster list.">b_cache_file</a> = b_for_file;
<a name="l00916"></a>00916    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9fbad8d6dc29d31a77b92c759ecfeba8" title="LUN of cluster list.">u8_lun</a>       = 0xFF;                     <span class="comment">// unvalid cache</span>
<a name="l00917"></a>00917    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#3993609419d886d6bbd71d4b1381d5d8" title="First cluster of cluster list.">u32_cluster</a>  = <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>;
<a name="l00918"></a>00918    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a>    = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 
<a name="l00924"></a><a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6">00924</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a>( <span class="keywordtype">void</span> )
<a name="l00925"></a>00925 {
<a name="l00926"></a>00926    U8 u8_cluster_offset = <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a> % <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>;
<a name="l00927"></a>00927    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9fbad8d6dc29d31a77b92c759ecfeba8" title="LUN of cluster list.">u8_lun</a>       = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a>;          <span class="comment">// valid cache</span>
<a name="l00928"></a>00928    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a>   -= u8_cluster_offset;
<a name="l00929"></a>00929    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#4c7ff1bd6744c489ae810368e9c29370" title="Address corresponding at the position &amp;quot;start&amp;quot; in cluster list.">u32_addr</a>     = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> - u8_cluster_offset;
<a name="l00930"></a>00930    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#e6b4023e4165ec69fe73bd693adb709a" title="Cluster list size.">u32_size</a>     = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> + u8_cluster_offset;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932    <span class="comment">// Update the "level used" of cache</span>
<a name="l00933"></a>00933    <a class="code" href="a00024.html#000e1da834dabe29da28f2110f8ba6c9" title="This function signals that a cache is used.">fat_cache_clusterlist_update_select</a>();
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 
<a name="l00939"></a><a class="code" href="a00024.html#000e1da834dabe29da28f2110f8ba6c9">00939</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#000e1da834dabe29da28f2110f8ba6c9" title="This function signals that a cache is used.">fat_cache_clusterlist_update_select</a>( <span class="keywordtype">void</span> )
<a name="l00940"></a>00940 {
<a name="l00941"></a>00941    U8 u8_i;
<a name="l00942"></a>00942    U8 u8_level_to_update;
<a name="l00943"></a>00943    Bool b_file_cache;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945    b_file_cache         = <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[ <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a> ].<a class="code" href="a00006.html#1826ec47ceec3f316fb4af191b919998" title="Signal a cluster cache from file cluster list or directory cluster list.">b_cache_file</a>;
<a name="l00946"></a>00946    u8_level_to_update   = <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[ <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a> ].<a class="code" href="a00006.html#a91792be887473384687bac546fae6bb" title="Cache level, 0 for the last used and up to FS_NB_CACHE_CLUSLIST-1 for the old access...">u8_level_use</a>;
<a name="l00947"></a>00947    <span class="keywordflow">for</span>( u8_i=0; u8_i&lt;(<a class="code" href="a00021.html#ee9842c6b2f49d1bca72d0ad56e97502" title="Number of caches used to store a cluster list of files (interesting in case of many...">FS_NB_CACHE_CLUSLIST</a>*2); u8_i++ )
<a name="l00948"></a>00948    {
<a name="l00949"></a>00949       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].b_cache_file == b_file_cache )
<a name="l00950"></a>00950          <span class="keywordflow">if</span>( u8_level_to_update &gt; <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].u8_level_use )
<a name="l00951"></a>00951            <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#a91792be887473384687bac546fae6bb" title="Cache level, 0 for the last used and up to FS_NB_CACHE_CLUSLIST-1 for the old access...">u8_level_use</a>++;
<a name="l00952"></a>00952    }
<a name="l00953"></a>00953    <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[  <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>  ].<a class="code" href="a00006.html#a91792be887473384687bac546fae6bb" title="Cache level, 0 for the last used and up to FS_NB_CACHE_CLUSLIST-1 for the old access...">u8_level_use</a> = 0;
<a name="l00954"></a>00954 }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 
<a name="l00964"></a><a class="code" href="a00024.html#b4f9f4f20c7e1ef6fa76ddc52cdc54f1">00964</a> Bool  <a class="code" href="a00024.html#b4f9f4f20c7e1ef6fa76ddc52cdc54f1" title="This function searchs a cluster list in cluster list caches.">fat_cache_clusterlist_update_read</a>( Bool b_for_file )
<a name="l00965"></a>00965 {
<a name="l00966"></a>00966    U32 u32_tmp;
<a name="l00967"></a>00967    U8 u8_i;
<a name="l00968"></a>00968    <span class="keywordflow">for</span>( u8_i=0; u8_i&lt;(<a class="code" href="a00021.html#ee9842c6b2f49d1bca72d0ad56e97502" title="Number of caches used to store a cluster list of files (interesting in case of many...">FS_NB_CACHE_CLUSLIST</a>*2); u8_i++ )
<a name="l00969"></a>00969    {
<a name="l00970"></a>00970       <span class="keywordflow">if</span>( (<a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].b_cache_file == b_for_file)
<a name="l00971"></a>00971       &amp;&amp;  (<a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#9fbad8d6dc29d31a77b92c759ecfeba8" title="LUN of cluster list.">u8_lun</a> == <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> ) )
<a name="l00972"></a>00972       {
<a name="l00973"></a>00973          <span class="keywordflow">if</span>( <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].u32_cluster == <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a> )
<a name="l00974"></a>00974          {
<a name="l00975"></a>00975             <span class="keywordflow">if</span>( <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].u32_start &lt;= <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> )
<a name="l00976"></a>00976             {
<a name="l00977"></a>00977                <span class="comment">// The segment research is in or after the cache</span>
<a name="l00978"></a>00978                <span class="keywordflow">if</span>( <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].u32_size  &gt; (<a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>-<a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a>) )
<a name="l00979"></a>00979                {
<a name="l00980"></a>00980                   <span class="comment">//** The segment research is in cache, then compute the segment infos</span>
<a name="l00981"></a>00981                   <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> -= <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a>;
<a name="l00982"></a>00982                   <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#4c7ff1bd6744c489ae810368e9c29370" title="Address corresponding at the position &amp;quot;start&amp;quot; in cluster list.">u32_addr</a> + <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00983"></a>00983                   <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#e6b4023e4165ec69fe73bd693adb709a" title="Cluster list size.">u32_size</a> - <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l00984"></a>00984                   <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a> = u8_i;
<a name="l00985"></a>00985                   <a class="code" href="a00024.html#000e1da834dabe29da28f2110f8ba6c9" title="This function signals that a cache is used.">fat_cache_clusterlist_update_select</a>();
<a name="l00986"></a>00986                   <span class="keywordflow">return</span> TRUE;   <span class="comment">// the segment is in cluster list cache</span>
<a name="l00987"></a>00987                }<span class="keywordflow">else</span>{
<a name="l00988"></a>00988                   <span class="comment">//** It is after the cache then get cache information and continue to read the cluster list in FAT</span>
<a name="l00989"></a>00989                   <span class="comment">// Store the resultat in this cache</span>
<a name="l00990"></a>00990                   <a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a> = u8_i;
<a name="l00991"></a>00991                   <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9fbad8d6dc29d31a77b92c759ecfeba8" title="LUN of cluster list.">u8_lun</a>       = 0xFF;   <span class="comment">// unvalid cache</span>
<a name="l00992"></a>00992                   <span class="comment">// fs_g_cache_clusterlist[fs_g_u8_current_cache].u32_cluster  = fs_g_cluster.u32_pos;  // It is the same cluster start</span>
<a name="l00993"></a>00993 
<a name="l00994"></a>00994                   <span class="comment">// Get cache information to take time during the next FAT access</span>
<a name="l00995"></a>00995                   <span class="comment">// Compute the cluster number corresponding at the last cluster of the cluster list cache</span>
<a name="l00996"></a>00996                   <a class="code" href="a00025.html#f1ca07cf6181c8e6af3fa988a0b0539d" title="To take time in functions: fat_getfreespace, fat_cluster_list, fat_cluster_val, fat_checkcluster...">fs_g_cluster</a>.<a class="code" href="a00017.html#06879786792eeefd3b45527499ed1174" title="cluster position">u32_pos</a>     = ((<a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#4c7ff1bd6744c489ae810368e9c29370" title="Address corresponding at the position &amp;quot;start&amp;quot; in cluster list.">u32_addr</a> -<a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af1d8fda28bded48a54c7eab4d729618" title="FAT address (unit 512B).">u32_ptr_fat</a> - <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#4666662ac4fa96c340a61e5fb786b83a" title="Offset between the beginning of FAT and the first cluster (unit 512B).">u32_offset_data</a> + <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#e6b4023e4165ec69fe73bd693adb709a" title="Cluster list size.">u32_size</a> -1)
<a name="l00997"></a>00997                                              / <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>) +2;
<a name="l00998"></a>00998                   u32_tmp  = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;                                 <span class="comment">// save position ask</span>
<a name="l00999"></a>00999                   <span class="comment">// Compute the position of the end of cluster list cache, and decrement the position asked</span>
<a name="l01000"></a>01000                   <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>-= ((<a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a> + <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00006.html#e6b4023e4165ec69fe73bd693adb709a" title="Cluster list size.">u32_size</a> -1)
<a name="l01001"></a>01001                                              / <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>)
<a name="l01002"></a>01002                                              * <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>;
<a name="l01003"></a>01003                   <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a> = u32_tmp;   <span class="comment">// Update cache with the position asked</span>
<a name="l01004"></a>01004                   <span class="keywordflow">return</span> FALSE;                                                        <span class="comment">// The segment isn't in cluster list cache</span>
<a name="l01005"></a>01005                }
<a name="l01006"></a>01006             }
<a name="l01007"></a>01007          }
<a name="l01008"></a>01008       }
<a name="l01009"></a>01009    }
<a name="l01010"></a>01010    <span class="comment">// No found in cache then read FAT and store the resultat in cache</span>
<a name="l01011"></a>01011    <a class="code" href="a00024.html#98a226b82d5df9c085d050fb341d8c6c" title="This function initializes a cache in cluster list caches.">fat_cache_clusterlist_update_start</a>(b_for_file);
<a name="l01012"></a>01012    <span class="keywordflow">return</span> FALSE;
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01016"></a>01016 
<a name="l01017"></a>01017 
<a name="l01035"></a><a class="code" href="a00025.html#d8c9c9a63c821e8cea06c340c029668d">01035</a> Bool  <a class="code" href="a00024.html#d8c9c9a63c821e8cea06c340c029668d" title="This function gets or clears a cluster list at the current position in the selected...">fat_read_file</a>( U8 mode )
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037    U32   u32_sector_pos;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039    <span class="comment">// Compute sector position</span>
<a name="l01040"></a>01040    u32_sector_pos = <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#1e1dae249ae6839c1b8cce0fecbbf7af" title="Current position in file (unit Bytes).">u32_pos_in_file</a> &gt;&gt; <a class="code" href="a00025.html#aee8167d49f58301e72fa2c546cd5b55">FS_512B_SHIFT_BIT</a>;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042    <span class="keywordflow">if</span>(<a class="code" href="a00025.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a>  == mode)
<a name="l01043"></a>01043    {
<a name="l01044"></a>01044       <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a>                 == <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l01045"></a>01045       &amp;&amp;  (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#9aba32679527ef002f0bbf18545108cf" title="first cluster of cluster list">u32_clusterlist_start</a>  == <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> )
<a name="l01046"></a>01046       &amp;&amp;  (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#0e983c43b8457d480b14ef77113df31f" title="position in cluster list (unit 512B)">u32_clusterlist_pos</a>    == u32_sector_pos ) )
<a name="l01047"></a>01047       {
<a name="l01048"></a>01048          <span class="keywordflow">return</span> TRUE;      <span class="comment">// The internal cache contains the sector ascked</span>
<a name="l01049"></a>01049       }
<a name="l01050"></a>01050    }
<a name="l01051"></a>01051    <span class="keywordflow">else</span>
<a name="l01052"></a>01052    {
<a name="l01053"></a>01053       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == mode )
<a name="l01054"></a>01054       {
<a name="l01055"></a>01055          <span class="comment">// Clear cluster list</span>
<a name="l01056"></a>01056          <span class="keywordflow">if</span>( 0 == <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> )
<a name="l01057"></a>01057             <span class="keywordflow">return</span> TRUE;   <span class="comment">// No cluster list is linked with the file, then no clear is necessary</span>
<a name="l01058"></a>01058 
<a name="l01059"></a>01059          <span class="keywordflow">if</span>(0 != (<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#1e1dae249ae6839c1b8cce0fecbbf7af" title="Current position in file (unit Bytes).">u32_pos_in_file</a> &amp; <a class="code" href="a00025.html#88ac363f9c597edc80e1185f99434056">FS_512B_MASK</a>) )
<a name="l01060"></a>01060          {
<a name="l01061"></a>01061             <span class="comment">// The actual sector is used, then start clear on the next sector</span>
<a name="l01062"></a>01062             u32_sector_pos++;
<a name="l01063"></a>01063          }
<a name="l01064"></a>01064       }
<a name="l01065"></a>01065    }
<a name="l01066"></a>01066 
<a name="l01067"></a>01067    <span class="comment">// Get the segment which start at the current position</span>
<a name="l01068"></a>01068    <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>;
<a name="l01069"></a>01069    <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = u32_sector_pos;
<a name="l01070"></a>01070    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> != mode )
<a name="l01071"></a>01071    {
<a name="l01072"></a>01072       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#b08a718173c6b1a1966e6395801a32e7" title="This function gets or clears a cluster list.">fat_cluster_list</a>( mode, TRUE ) )
<a name="l01073"></a>01073          <span class="keywordflow">return</span> TRUE;      <span class="comment">// Get or clear segment OK</span>
<a name="l01074"></a>01074    }
<a name="l01075"></a>01075    <span class="keywordflow">else</span>
<a name="l01076"></a>01076    {
<a name="l01077"></a>01077       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#b08a718173c6b1a1966e6395801a32e7" title="This function gets or clears a cluster list.">fat_cluster_list</a>( <a class="code" href="a00025.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a>, TRUE ) )   <span class="comment">// Read all segment</span>
<a name="l01078"></a>01078       {
<a name="l01079"></a>01079          <span class="comment">// Read the sector corresponding at the position file (= first sector of segment)</span>
<a name="l01080"></a>01080          <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> ;
<a name="l01081"></a>01081          <span class="keywordflow">if</span>( <a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ) )
<a name="l01082"></a>01082          {
<a name="l01083"></a>01083             <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#9aba32679527ef002f0bbf18545108cf" title="first cluster of cluster list">u32_clusterlist_start</a>  = <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>;
<a name="l01084"></a>01084             <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#0e983c43b8457d480b14ef77113df31f" title="position in cluster list (unit 512B)">u32_clusterlist_pos</a>    = u32_sector_pos;
<a name="l01085"></a>01085             <span class="keywordflow">return</span> TRUE;
<a name="l01086"></a>01086          }
<a name="l01087"></a>01087       }
<a name="l01088"></a>01088    }
<a name="l01089"></a>01089    <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == mode       )
<a name="l01090"></a>01090    &amp;&amp;  (<a class="code" href="a00031.html#e8798a89bfc4f49da50fc55b14a5b07f" title="The position is outside the cluster list.">FS_ERR_OUT_LIST</a>  == <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a>) )
<a name="l01091"></a>01091    {
<a name="l01092"></a>01092       <span class="comment">// It is possible to clear nothing</span>
<a name="l01093"></a>01093       <span class="keywordflow">return</span> TRUE;
<a name="l01094"></a>01094    }
<a name="l01095"></a>01095    <span class="keywordflow">return</span> FALSE;
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098 
<a name="l01099"></a>01099 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l01117"></a><a class="code" href="a00025.html#8723a199c01163d9f9839bd42ac60693">01117</a> <span class="preprocessor">Bool  fat_write_file( U8 mode , U32 u32_nb_sector_write )</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span>{
<a name="l01119"></a>01119    <span class="keywordflow">if</span>( 0 == <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> )
<a name="l01120"></a>01120    {
<a name="l01121"></a>01121       <span class="comment">// File don't have a cluster list, then alloc the first cluster list of the file</span>
<a name="l01122"></a>01122       MSB0(<a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>)    = 0xFF;     <span class="comment">// It is a new cluster list</span>
<a name="l01123"></a>01123       <span class="comment">// Update cluster list caches</span>
<a name="l01124"></a>01124       <span class="comment">// fs_g_cluster.u32_pos    = ?         // To fill after alloc</span>
<a name="l01125"></a>01125       <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>   = 0;
<a name="l01126"></a>01126       <a class="code" href="a00024.html#98a226b82d5df9c085d050fb341d8c6c" title="This function initializes a cache in cluster list caches.">fat_cache_clusterlist_update_start</a>(TRUE);
<a name="l01127"></a>01127    }
<a name="l01128"></a>01128    <span class="keywordflow">else</span>
<a name="l01129"></a>01129    {
<a name="l01130"></a>01130       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#d8c9c9a63c821e8cea06c340c029668d" title="This function gets or clears a cluster list at the current position in the selected...">fat_read_file</a>( mode ) )
<a name="l01131"></a>01131          <span class="keywordflow">return</span> TRUE;      <span class="comment">// A segment is availabled (no alloc necessary)</span>
<a name="l01132"></a>01132 
<a name="l01133"></a>01133       <span class="keywordflow">if</span>( <a class="code" href="a00031.html#e8798a89bfc4f49da50fc55b14a5b07f" title="The position is outside the cluster list.">FS_ERR_OUT_LIST</a> != <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l01134"></a>01134       {
<a name="l01135"></a>01135          <span class="keywordflow">return</span> FALSE;     <span class="comment">// Error system</span>
<a name="l01136"></a>01136       }
<a name="l01137"></a>01137       <span class="comment">// fat_read_file is outsize the list then the current cluster list cache contains the last cluster</span>
<a name="l01138"></a>01138 
<a name="l01139"></a>01139       <span class="comment">// Initialize cluster list caches before alloc routine</span>
<a name="l01140"></a>01140       <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9fbad8d6dc29d31a77b92c759ecfeba8" title="LUN of cluster list.">u8_lun</a>       = 0xFF;                     <span class="comment">// unvalid cache</span>
<a name="l01141"></a>01141       <span class="comment">// fs_g_cache_clusterlist[fs_g_u8_current_cache].u32_cluster  = fs_g_cluster.u32_pos;  // it is the same</span>
<a name="l01142"></a>01142       <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c" title="Start position in the cluster list (unit 512B).">u32_start</a> += <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>; <span class="comment">// Position of next cluster (the first new)</span>
<a name="l01143"></a>01143    }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145    <span class="comment">// Alloc a cluster list</span>
<a name="l01146"></a>01146    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == mode )
<a name="l01147"></a>01147    {
<a name="l01148"></a>01148       <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = u32_nb_sector_write;
<a name="l01149"></a>01149    }<span class="keywordflow">else</span>{
<a name="l01150"></a>01150       <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = 1;                                                          <span class="comment">// only one sector</span>
<a name="l01151"></a>01151    }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153    <span class="comment">//note: fs_g_seg.u32_addr is already initialized with the last cluster value (see fat_cluster_list())</span>
<a name="l01154"></a>01154    <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#1fa62b2728e71cff2e95556db7ed1b9c" title="This function allocs a cluster list.">fat_allocfreespace</a>())
<a name="l01155"></a>01155       <span class="keywordflow">return</span> FALSE;
<a name="l01156"></a>01156    <span class="comment">//note: fs_g_seg.u32_addr is the first cluster of the cluster list allocated by alloc_free_space()</span>
<a name="l01157"></a>01157    <span class="comment">//note: fs_g_seg.u32_size_or_pos = number of sectors remaining</span>
<a name="l01158"></a>01158 
<a name="l01159"></a>01159    <span class="keywordflow">if</span>( 0 == <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> )
<a name="l01160"></a>01160    {
<a name="l01161"></a>01161       <span class="comment">// It is the first cluster list of file, then update following values in cluster list cache</span>
<a name="l01162"></a>01162       <span class="comment">// fs_g_seg.u32_addr = already contzins the first cluster of the file (see alloc_free_space())</span>
<a name="l01163"></a>01163       <a class="code" href="a00024.html#2c119a8b66b97a6c14624fb941889a24">fs_g_cache_clusterlist</a>[<a class="code" href="a00024.html#07bae2654ebf3c7d64078af69ccebd3b">fs_g_u8_current_cache</a>].<a class="code" href="a00006.html#3993609419d886d6bbd71d4b1381d5d8" title="First cluster of cluster list.">u32_cluster</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>;
<a name="l01164"></a>01164       <span class="comment">// Update file entry</span>
<a name="l01165"></a>01165       <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>;
<a name="l01166"></a>01166    }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168    <span class="comment">// Update cluster list cache</span>
<a name="l01169"></a>01169    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == mode )
<a name="l01170"></a>01170    {
<a name="l01171"></a>01171       <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = u32_nb_sector_write - <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l01172"></a>01172    }<span class="keywordflow">else</span>{
<a name="l01173"></a>01173       <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = 1 - <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a>;
<a name="l01174"></a>01174    }
<a name="l01175"></a>01175    <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = ((<a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> - 2) * <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#cddebea9972567fdcb5b87327b48125e" title="Cluster size (unit 512B).">u8_BPB_SecPerClus</a>)
<a name="l01176"></a>01176                      + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af1d8fda28bded48a54c7eab4d729618" title="FAT address (unit 512B).">u32_ptr_fat</a> + <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#4666662ac4fa96c340a61e5fb786b83a" title="Offset between the beginning of FAT and the first cluster (unit 512B).">u32_offset_data</a>;
<a name="l01177"></a>01177    <a class="code" href="a00024.html#2ae33c7eebc67cd4cf420593aa2c97d6" title="This function updates a cache of cluster list caches.">fat_cache_clusterlist_update_finish</a>();
<a name="l01178"></a>01178 
<a name="l01179"></a>01179    <span class="keywordflow">return</span> <a class="code" href="a00024.html#d8c9c9a63c821e8cea06c340c029668d" title="This function gets or clears a cluster list at the current position in the selected...">fat_read_file</a>( mode );    <span class="comment">// load the new cluster list</span>
<a name="l01180"></a>01180 }
<a name="l01181"></a>01181 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01182"></a>01182 <span class="preprocessor"></span>
<a name="l01195"></a><a class="code" href="a00025.html#1a35321a99150ba643f87cb6c79ec3e5">01195</a> Bool  <a class="code" href="a00024.html#1a35321a99150ba643f87cb6c79ec3e5" title="This function fill the internal cache with a sector from current directory.">fat_read_dir</a>( <span class="keywordtype">void</span> )
<a name="l01196"></a>01196 {
<a name="l01197"></a>01197    U32 u32_cluster_pos;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199    <span class="comment">// Compute the cluster list position corresponding of the current entry</span>
<a name="l01200"></a>01200    u32_cluster_pos = <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#9f50297ed427918e54da99b8c4fbaf04" title="Entry file position in directory (unit = FS_SIZE_FILE_ENTRY) (see value FS_NO_SEL...">u16_entry_pos_sel_file</a> &gt;&gt; (<a class="code" href="a00025.html#aee8167d49f58301e72fa2c546cd5b55">FS_512B_SHIFT_BIT</a> - <a class="code" href="a00025.html#f5a730740b41e20c1a467dcd1d52699f">FS_SHIFT_B_TO_FILE_ENTRY</a>);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202    <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a>                 == <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l01203"></a>01203    &amp;&amp;  (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#9aba32679527ef002f0bbf18545108cf" title="first cluster of cluster list">u32_clusterlist_start</a>  == <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#ed8faad36e96ff2f422ddadd3740713f" title="First cluster number of selected directory (0 for the root directory).">u32_cluster_sel_dir</a> )
<a name="l01204"></a>01204    &amp;&amp;  (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#0e983c43b8457d480b14ef77113df31f" title="position in cluster list (unit 512B)">u32_clusterlist_pos</a>    == u32_cluster_pos ) )
<a name="l01205"></a>01205    {
<a name="l01206"></a>01206          <span class="keywordflow">return</span> TRUE;      <span class="comment">// The internal cache contains the sector ascked</span>
<a name="l01207"></a>01207    }
<a name="l01208"></a>01208 
<a name="l01209"></a>01209    <span class="comment">// Get sector address corresponding at cluster list position</span>
<a name="l01210"></a>01210    <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#ed8faad36e96ff2f422ddadd3740713f" title="First cluster number of selected directory (0 for the root directory).">u32_cluster_sel_dir</a>;
<a name="l01211"></a>01211    <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#09c9847870bc2202980b54e38ea62fae" title="segment size (unit 512B), or position in cluster list (unit 512B)">u32_size_or_pos</a> = u32_cluster_pos;
<a name="l01212"></a>01212    <span class="keywordflow">if</span>( <a class="code" href="a00024.html#b08a718173c6b1a1966e6395801a32e7" title="This function gets or clears a cluster list.">fat_cluster_list</a>( <a class="code" href="a00025.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a>, FALSE ) )
<a name="l01213"></a>01213    {
<a name="l01214"></a>01214       <span class="comment">// Read the sector</span>
<a name="l01215"></a>01215       <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a> = <a class="code" href="a00025.html#6d934f26f97b442c30712e57ee8b21e5" title="Variable frequently used by many function (optimization, no parameter in function)...">fs_g_seg</a>.<a class="code" href="a00014.html#da7b79119fecdfb1faab2512eb0ee172" title="segment address (unit 512B), or cluster number">u32_addr</a>;
<a name="l01216"></a>01216       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( TRUE ) )
<a name="l01217"></a>01217       {
<a name="l01218"></a>01218          <span class="comment">// Update information about internal sector cache</span>
<a name="l01219"></a>01219          <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#9aba32679527ef002f0bbf18545108cf" title="first cluster of cluster list">u32_clusterlist_start</a>  = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#ed8faad36e96ff2f422ddadd3740713f" title="First cluster number of selected directory (0 for the root directory).">u32_cluster_sel_dir</a>;
<a name="l01220"></a>01220          <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#0e983c43b8457d480b14ef77113df31f" title="position in cluster list (unit 512B)">u32_clusterlist_pos</a>    = u32_cluster_pos;
<a name="l01221"></a>01221          <span class="keywordflow">return</span> TRUE;
<a name="l01222"></a>01222       }
<a name="l01223"></a>01223    }
<a name="l01224"></a>01224    <span class="keywordflow">return</span> FALSE;
<a name="l01225"></a>01225 }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227 
<a name="l01228"></a>01228 
<a name="l01243"></a><a class="code" href="a00025.html#ef13c743905d7e0381b3a461da2ebd7a">01243</a> Bool  <a class="code" href="a00024.html#ef13c743905d7e0381b3a461da2ebd7a" title="This function checks the entry.">fat_entry_check</a>( Bool b_type )
<a name="l01244"></a>01244 {
<a name="l01245"></a>01245    <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> u8_ptr_entry;
<a name="l01246"></a>01246    U8 u8_first_byte, u8_seconde_byte;
<a name="l01247"></a>01247    U8 u8_attribut;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249    u8_ptr_entry = <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>();
<a name="l01250"></a>01250 
<a name="l01251"></a>01251    u8_first_byte = u8_ptr_entry[0];
<a name="l01252"></a>01252    <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#453bf57f059970b3ce13033b7959cb0c">FS_ENTRY_END</a> == u8_first_byte )
<a name="l01253"></a>01253    {
<a name="l01254"></a>01254       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#33817136df196a5f0146574b4e1775b6" title="File entry empty.">FS_ERR_ENTRY_EMPTY</a>;   <span class="comment">// end of directory</span>
<a name="l01255"></a>01255       <span class="keywordflow">return</span> FALSE;
<a name="l01256"></a>01256    }
<a name="l01257"></a>01257    <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#934f48a8e1cb558d75ec00bbd242030d" title="File entry bad.">FS_ERR_ENTRY_BAD</a>;        <span class="comment">// by default BAD ENTRY</span>
<a name="l01258"></a>01258    <span class="keywordflow">if</span> ( <a class="code" href="a00025.html#303c1237fa5a61ddc015c0365eedd008">FS_ENTRY_DEL</a> == u8_first_byte )      { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// entry deleted</span>
<a name="l01259"></a>01259    <span class="keywordflow">if</span> (   <span class="charliteral">'.'</span>  == u8_first_byte )            { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// current dir "."</span>
<a name="l01260"></a>01260    u8_seconde_byte = u8_ptr_entry[1];
<a name="l01261"></a>01261    <span class="keywordflow">if</span> ( (<span class="charliteral">'.'</span>  == u8_first_byte)
<a name="l01262"></a>01262    &amp;&amp;   (<span class="charliteral">'.'</span>  == u8_seconde_byte) )          { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// current dir ".."</span>
<a name="l01263"></a>01263 
<a name="l01264"></a>01264    <span class="comment">// Check attribut</span>
<a name="l01265"></a>01265    u8_attribut = u8_ptr_entry[11];
<a name="l01266"></a>01266    <span class="keywordflow">if</span> ( <a class="code" href="a00031.html#4ed995c53b13fcf1694ae3ba6da61eba">FS_ATTR_VOLUME_ID</a> &amp; u8_attribut )    { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// volume id</span>
<a name="l01267"></a>01267    <span class="comment">// Optimization, this line isn't necessary because the next test control this case</span>
<a name="l01268"></a>01268    <span class="comment">// if ( FS_ATTR_LFN_ENTRY == *u8_ptr_entry) { return FALSE;   } // long file name</span>
<a name="l01269"></a>01269 
<a name="l01270"></a>01270    <span class="comment">// Check entry type</span>
<a name="l01271"></a>01271    <span class="keywordflow">if</span>( <a class="code" href="a00031.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a> &amp; u8_attribut )
<a name="l01272"></a>01272    {
<a name="l01273"></a>01273       <span class="keywordflow">return</span> (<a class="code" href="a00031.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a> == b_type);
<a name="l01274"></a>01274    }<span class="keywordflow">else</span>{
<a name="l01275"></a>01275       <span class="keywordflow">return</span> (<a class="code" href="a00031.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a> == b_type);
<a name="l01276"></a>01276    }
<a name="l01277"></a>01277 }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279 
<a name="l01294"></a><a class="code" href="a00025.html#d690d22df98e6c1fa927c38b1d1a0fae">01294</a> Bool  <a class="code" href="a00024.html#d690d22df98e6c1fa927c38b1d1a0fae" title="This function checks the file extension.">fat_entry_checkext</a>( <a class="code" href="a00031.html#caff53a7315dfcce82e06ae11c771e8c">FS_STRING</a> sz_filter )
<a name="l01295"></a>01295 {
<a name="l01296"></a>01296    <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> u8_ptr_entry;
<a name="l01297"></a>01297    U8 u8_i, u8_filter_char, u8_entry_char;
<a name="l01298"></a>01298 
<a name="l01299"></a>01299    u8_ptr_entry = <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>();
<a name="l01300"></a>01300 
<a name="l01301"></a>01301    <span class="comment">// Compare the extension with filter</span>
<a name="l01302"></a>01302    <span class="keywordflow">for</span>( u8_i=0 ; u8_i&lt;3 ; u8_i++)
<a name="l01303"></a>01303    {
<a name="l01304"></a>01304       u8_filter_char = *sz_filter;
<a name="l01305"></a>01305       <span class="keywordflow">if</span> (<span class="charliteral">'*'</span> == u8_filter_char)
<a name="l01306"></a>01306          <span class="keywordflow">break</span>; <span class="comment">// All extension is good</span>
<a name="l01307"></a>01307 
<a name="l01308"></a>01308       u8_entry_char = u8_ptr_entry[8+u8_i];
<a name="l01309"></a>01309 
<a name="l01310"></a>01310       <span class="comment">// Compare the extension filter to extension file (this one ignore the case)</span>
<a name="l01311"></a>01311       <span class="keywordflow">if</span>( (u8_filter_char!=  u8_entry_char     )
<a name="l01312"></a>01312       &amp;&amp;  (u8_filter_char!= (u8_entry_char+(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) )
<a name="l01313"></a>01313       {
<a name="l01314"></a>01314          <span class="keywordflow">if</span> ( (<span class="charliteral">','</span> == u8_filter_char)
<a name="l01315"></a>01315          ||   ( 0  == u8_filter_char) )
<a name="l01316"></a>01316          {
<a name="l01317"></a>01317            <span class="comment">// It is the end of filter</span>
<a name="l01318"></a>01318            <span class="keywordflow">if</span> (<span class="charliteral">' '</span> == u8_entry_char)
<a name="l01319"></a>01319               <span class="keywordflow">break</span>; <span class="comment">// it is the end of extension file -&gt; extension good</span>
<a name="l01320"></a>01320          }
<a name="l01321"></a>01321          <span class="comment">// here, bad extension</span>
<a name="l01322"></a>01322 
<a name="l01323"></a>01323          <span class="comment">// Search the next filter</span>
<a name="l01324"></a>01324          <span class="keywordflow">while</span>( <span class="charliteral">','</span> != u8_filter_char )
<a name="l01325"></a>01325          {
<a name="l01326"></a>01326             <span class="keywordflow">if</span> (0  == u8_filter_char)
<a name="l01327"></a>01327             {
<a name="l01328"></a>01328                <span class="keywordflow">return</span> FALSE;   <span class="comment">// it is the last filter</span>
<a name="l01329"></a>01329             }
<a name="l01330"></a>01330             sz_filter++;
<a name="l01331"></a>01331             u8_filter_char = *sz_filter;
<a name="l01332"></a>01332          }
<a name="l01333"></a>01333          u8_i = 0xFF;          <span class="comment">// restart loop compare</span>
<a name="l01334"></a>01334       }
<a name="l01335"></a>01335       sz_filter++; <span class="comment">// go to next char of filter</span>
<a name="l01336"></a>01336    }
<a name="l01337"></a>01337 
<a name="l01338"></a>01338    <span class="keywordflow">return</span> TRUE; <span class="comment">// It is a good extension</span>
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341 
<a name="l01353"></a><a class="code" href="a00025.html#56b68ed36f194500ce88c22252e3c317">01353</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#56b68ed36f194500ce88c22252e3c317" title="This function reads information about selected file.">fat_get_entry_info</a>( <span class="keywordtype">void</span> )
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355    <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357    ptr_entry = <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>();
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    <span class="comment">// Get attribut</span>
<a name="l01360"></a>01360    ptr_entry+= 11;
<a name="l01361"></a>01361    <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#c4f33191c9fd60c7520012bbe6005267" title="Attribut of the selected file.">u8_attr</a> = ptr_entry[0];
<a name="l01362"></a>01362 
<a name="l01363"></a>01363    <span class="comment">// Get the first cluster of the file cluster list</span>
<a name="l01364"></a>01364    ptr_entry += (20-11);
<a name="l01365"></a>01365    LSB2(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>) = ptr_entry[0];
<a name="l01366"></a>01366    LSB3(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>) = ptr_entry[1];
<a name="l01367"></a>01367    ptr_entry += (26-20);
<a name="l01368"></a>01368    LSB0(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>) = ptr_entry[0];
<a name="l01369"></a>01369    LSB1(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>) = ptr_entry[1];
<a name="l01370"></a>01370 
<a name="l01371"></a>01371    <span class="comment">// Get the size of file</span>
<a name="l01372"></a>01372    ptr_entry += (28-26);
<a name="l01373"></a>01373    LSB0(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>) = ptr_entry[0];
<a name="l01374"></a>01374    LSB1(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>) = ptr_entry[1];
<a name="l01375"></a>01375    LSB2(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>) = ptr_entry[2];
<a name="l01376"></a>01376    LSB3(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>) = ptr_entry[3];
<a name="l01377"></a>01377 }
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 
<a name="l01385"></a><a class="code" href="a00025.html#e0caae1c6e4a737af4ad0aa5d4171e79">01385</a> Bool  <a class="code" href="a00024.html#e0caae1c6e4a737af4ad0aa5d4171e79" title="This function checks if the entry file is a directory.">fat_entry_is_dir</a>(<span class="keywordtype">void</span>)
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387    <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#4374de2d1b7c653404d71d049b963e10" title="The selected file isn&amp;#39;t a directory.">FS_ERR_NO_DIR</a>;
<a name="l01388"></a>01388    <span class="keywordflow">return</span> (<a class="code" href="a00031.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a> &amp; <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#c4f33191c9fd60c7520012bbe6005267" title="Attribut of the selected file.">u8_attr</a>);
<a name="l01389"></a>01389 }
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 
<a name="l01394"></a><a class="code" href="a00025.html#56d9a210bc2d4b0b5c46cb24a2e9f690">01394</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#56d9a210bc2d4b0b5c46cb24a2e9f690" title="This function resets the selection pointers.">fat_clear_entry_info_and_ptr</a>( <span class="keywordtype">void</span> )
<a name="l01395"></a>01395 {
<a name="l01396"></a>01396    <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#9f50297ed427918e54da99b8c4fbaf04" title="Entry file position in directory (unit = FS_SIZE_FILE_ENTRY) (see value FS_NO_SEL...">u16_entry_pos_sel_file</a>= <a class="code" href="a00025.html#2e16c6cfcb3174f7ad19ad3996a69ae7" title="Signal that a file entry isn&amp;#39;t selected.">FS_NO_SEL</a>;
<a name="l01397"></a>01397    <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#b0213ed9fc205b282b4c1d92adfa7460" title="File position in the file list (only used by navigation functions).">u16_pos_sel_file</a>           = <a class="code" href="a00025.html#2e16c6cfcb3174f7ad19ad3996a69ae7" title="Signal that a file entry isn&amp;#39;t selected.">FS_NO_SEL</a>;
<a name="l01398"></a>01398    <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#a77329e481dd65221af40a8c26b6541b" title="Navigation File List provide only files or directories.">b_mode_nav_single</a> )
<a name="l01399"></a>01399    {
<a name="l01400"></a>01400       <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#f36b5e65540c67c04d0ca489e2f52332" title="Navigation step ( FS_FILE or FS_DIR ).">b_mode_nav</a>                 = <a class="code" href="a00031.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a>;
<a name="l01401"></a>01401    }
<a name="l01402"></a>01402    <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#c4f33191c9fd60c7520012bbe6005267" title="Attribut of the selected file.">u8_attr</a>     = 0;
<a name="l01403"></a>01403    <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> = 0;
<a name="l01404"></a>01404    <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>    = 0;
<a name="l01405"></a>01405    <a class="code" href="a00025.html#55c673ca91c5301834a588e1d5a6515f">Fat_file_close</a>();
<a name="l01406"></a>01406 }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l01421"></a><a class="code" href="a00025.html#40035dc41d435ed3281155cdf800cf02">01421</a> <span class="preprocessor">void  fat_write_entry_file( void )</span>
<a name="l01422"></a>01422 <span class="preprocessor"></span>{
<a name="l01423"></a>01423    <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01424"></a>01424 
<a name="l01425"></a>01425    <a class="code" href="a00024.html#45c0f16885c9e414ddb4b5afaa1cde34" title="This function sets a flag to signal that sector cache is modified.">fat_cache_mark_sector_as_dirty</a>();
<a name="l01426"></a>01426    ptr_entry = <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>();
<a name="l01427"></a>01427 
<a name="l01428"></a>01428    <span class="keywordflow">if</span>( !(<a class="code" href="a00031.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a> | <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#c4f33191c9fd60c7520012bbe6005267" title="Attribut of the selected file.">u8_attr</a>))
<a name="l01429"></a>01429    {
<a name="l01430"></a>01430       <span class="keywordflow">if</span>( 0 == <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a> )
<a name="l01431"></a>01431          <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a> = 0;
<a name="l01432"></a>01432    }
<a name="l01433"></a>01433 
<a name="l01435"></a>01435    ptr_entry+= 11;
<a name="l01436"></a>01436    ptr_entry[0] = <a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#c4f33191c9fd60c7520012bbe6005267" title="Attribut of the selected file.">u8_attr</a>;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <span class="comment">// Write the first cluster of file cluster list</span>
<a name="l01439"></a>01439    ptr_entry += (20-11);
<a name="l01440"></a>01440    ptr_entry[0] = LSB2(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>);
<a name="l01441"></a>01441    ptr_entry[1] = LSB3(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>);
<a name="l01442"></a>01442    ptr_entry += (26-20);
<a name="l01443"></a>01443    ptr_entry[0] = LSB0(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>);
<a name="l01444"></a>01444    ptr_entry[1] = LSB1(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#eaa27a06eca82fa0f65d848def8a4b87" title="First cluster of the selected file.">u32_cluster</a>);
<a name="l01445"></a>01445 
<a name="l01447"></a>01447    ptr_entry += (28-26);
<a name="l01448"></a>01448    ptr_entry[0] = LSB0(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>);
<a name="l01449"></a>01449    ptr_entry[1] = LSB1(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>);
<a name="l01450"></a>01450    ptr_entry[2] = LSB2(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>);
<a name="l01451"></a>01451    ptr_entry[3] = LSB3(<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00010.html#6ffedc3932826a337dfb3e656a09edcc" title="Size of selected file (unit Bytes).">u32_size</a>);
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01454"></a>01454 <span class="preprocessor"></span>
<a name="l01455"></a>01455 
<a name="l01476"></a><a class="code" href="a00025.html#6bc798e9f4eac3457cc61e9cd9ba70b9">01476</a> Bool  <a class="code" href="a00024.html#6bc798e9f4eac3457cc61e9cd9ba70b9" title="This function returns or compares the short name entry.">fat_entry_shortname</a>( <a class="code" href="a00031.html#caff53a7315dfcce82e06ae11c771e8c">FS_STRING</a> sz_name , U8 u8_size_max , Bool b_mode )
<a name="l01477"></a>01477 {
<a name="l01478"></a>01478    Bool b_extension_nostart = TRUE;
<a name="l01479"></a>01479    U8 u8_pos_name;
<a name="l01480"></a>01480    U8 u8_entry_char, u8_szname_char;
<a name="l01481"></a>01481    <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01482"></a>01482    U8 u8_pos_entry;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484    <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#5ea145bbe1eb7413020b5e6b6f12a1ba" title="The name don&amp;#39;t corresponding at the filter name.">FS_ERR_NAME_INCORRECT</a>;  <span class="comment">// by default the name don't corresponding at filter name</span>
<a name="l01485"></a>01485 
<a name="l01486"></a>01486    u8_pos_name = 0;
<a name="l01487"></a>01487    u8_pos_entry = 0;
<a name="l01488"></a>01488    ptr_entry = <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>();
<a name="l01489"></a>01489 
<a name="l01490"></a>01490    <span class="comment">// for each characters of short name</span>
<a name="l01491"></a>01491    <span class="keywordflow">while</span>( 1 )
<a name="l01492"></a>01492    {
<a name="l01493"></a>01493       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#69da5456f1f42a68c03ac860e33ac75b">FS_SIZE_SFNAME</a> == u8_pos_entry )
<a name="l01494"></a>01494       {
<a name="l01495"></a>01495          u8_entry_char = 0;   <span class="comment">// end of name</span>
<a name="l01496"></a>01496       }
<a name="l01497"></a>01497       <span class="keywordflow">else</span>
<a name="l01498"></a>01498       {
<a name="l01499"></a>01499          u8_entry_char = ptr_entry[ u8_pos_entry ];
<a name="l01500"></a>01500          <span class="keywordflow">if</span>( ((<a class="code" href="a00025.html#18e4c969985c697213c58a67e7c20795">FS_SIZE_SFNAME_WITHOUT_EXT</a> == u8_pos_entry) &amp;&amp; b_extension_nostart)  <span class="comment">// end of name and '.' character no writed</span>
<a name="l01501"></a>01501          ||  ( <span class="charliteral">' '</span> == u8_entry_char) )
<a name="l01502"></a>01502          {
<a name="l01503"></a>01503             <span class="comment">// end of name or extension</span>
<a name="l01504"></a>01504             <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#18e4c969985c697213c58a67e7c20795">FS_SIZE_SFNAME_WITHOUT_EXT</a> &gt;= u8_pos_entry)         <span class="comment">// End of name without extension</span>
<a name="l01505"></a>01505             &amp;&amp;  (<span class="charliteral">' '</span> != ptr_entry[ <a class="code" href="a00025.html#18e4c969985c697213c58a67e7c20795">FS_SIZE_SFNAME_WITHOUT_EXT</a> ]) )   <span class="comment">// extension exists</span>
<a name="l01506"></a>01506             {
<a name="l01507"></a>01507                <span class="comment">// go to extension position</span>
<a name="l01508"></a>01508                b_extension_nostart = FALSE;
<a name="l01509"></a>01509                u8_pos_entry = FS_SIZE_SFNAME_WITHOUT_EXT-1;
<a name="l01510"></a>01510                u8_entry_char = <span class="charliteral">'.'</span>;
<a name="l01511"></a>01511             }
<a name="l01512"></a>01512             <span class="keywordflow">else</span>
<a name="l01513"></a>01513             {
<a name="l01514"></a>01514                u8_entry_char = 0;                                    <span class="comment">// end of name</span>
<a name="l01515"></a>01515             }
<a name="l01516"></a>01516          }
<a name="l01517"></a>01517       }
<a name="l01518"></a>01518 
<a name="l01519"></a>01519       <span class="keywordflow">if</span>( <a class="code" href="a00031.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode )
<a name="l01520"></a>01520       {
<a name="l01521"></a>01521          <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01522"></a>01522          {
<a name="l01523"></a>01523             <span class="keywordflow">if</span>(u8_pos_name &gt;= (u8_size_max-1))
<a name="l01524"></a>01524                u8_entry_char = 0;                                    <span class="comment">// buffer full then force end of string</span>
<a name="l01525"></a>01525 
<a name="l01526"></a>01526             <span class="keywordflow">if</span>( (<span class="charliteral">'A'</span>&lt;=u8_entry_char) &amp;&amp; (u8_entry_char&lt;=<span class="charliteral">'Z'</span>))
<a name="l01527"></a>01527                u8_entry_char += (<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>);                           <span class="comment">// display short name in down case</span>
<a name="l01528"></a>01528 
<a name="l01529"></a>01529             <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01530"></a>01530             {
<a name="l01531"></a>01531                ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = u8_entry_char;
<a name="l01532"></a>01532             }<span class="keywordflow">else</span>{
<a name="l01533"></a>01533                sz_name[0] = u8_entry_char;
<a name="l01534"></a>01534             }
<a name="l01535"></a>01535          }
<a name="l01536"></a>01536       }
<a name="l01537"></a>01537       <span class="keywordflow">else</span>
<a name="l01538"></a>01538       {
<a name="l01539"></a>01539          <span class="comment">// Compare the name</span>
<a name="l01540"></a>01540          <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>
<a name="l01541"></a>01541          &amp;&amp; (0 != MSB(((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0])) )
<a name="l01542"></a>01542          {
<a name="l01543"></a>01543             <span class="comment">// The UNICODE is not possibled in short name</span>
<a name="l01544"></a>01544             <span class="keywordflow">return</span> FALSE;
<a name="l01545"></a>01545          }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547          <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01548"></a>01548          {
<a name="l01549"></a>01549             u8_szname_char = ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0];
<a name="l01550"></a>01550          }<span class="keywordflow">else</span>{
<a name="l01551"></a>01551             u8_szname_char = sz_name[0];
<a name="l01552"></a>01552          }
<a name="l01553"></a>01553          <span class="keywordflow">if</span> (<span class="charliteral">'*'</span> == u8_szname_char)
<a name="l01554"></a>01554          {  <span class="comment">// end of filter name which autorise all next character</span>
<a name="l01555"></a>01555             <span class="keywordflow">return</span> TRUE;   <span class="comment">//*** The name is correct ***</span>
<a name="l01556"></a>01556          }
<a name="l01557"></a>01557 
<a name="l01558"></a>01558          <span class="keywordflow">if</span>( (0 != u8_entry_char) || ((<span class="charliteral">'\\'</span> != u8_szname_char) &amp;&amp; (<span class="charliteral">'/'</span> != u8_szname_char)) )
<a name="l01559"></a>01559          {
<a name="l01560"></a>01560             <span class="keywordflow">if</span>((u8_szname_char != u8_entry_char)
<a name="l01561"></a>01561             &amp;&amp; (u8_szname_char != (u8_entry_char+(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) )  <span class="comment">// no case sensitive</span>
<a name="l01562"></a>01562                <span class="keywordflow">return</span> FALSE;  <span class="comment">// short name not equal</span>
<a name="l01563"></a>01563          }
<a name="l01564"></a>01564       }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566       <span class="comment">// For each characters</span>
<a name="l01567"></a>01567       <span class="keywordflow">if</span> (0 == u8_entry_char)
<a name="l01568"></a>01568       {
<a name="l01569"></a>01569          <span class="keywordflow">if</span>( <a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01570"></a>01570          {
<a name="l01571"></a>01571             ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = u8_pos_name+1;      <span class="comment">// Get length name</span>
<a name="l01572"></a>01572          }
<a name="l01573"></a>01573          <span class="keywordflow">return</span> TRUE;   <span class="comment">// End of test correct or end of get name</span>
<a name="l01574"></a>01574       }
<a name="l01575"></a>01575       <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01576"></a>01576       {
<a name="l01577"></a>01577          sz_name += (<a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01578"></a>01578       }
<a name="l01579"></a>01579       u8_pos_name++;
<a name="l01580"></a>01580       u8_pos_entry++;
<a name="l01581"></a>01581    }
<a name="l01582"></a>01582 }
<a name="l01583"></a>01583 
<a name="l01584"></a>01584 
<a name="l01607"></a><a class="code" href="a00025.html#c0bdbd911ecf04b3fcebbc2e4ae33166">01607</a> Bool  <a class="code" href="a00024.html#c0bdbd911ecf04b3fcebbc2e4ae33166" title="This function returns or compares the long name entry.">fat_entry_longname</a>( <a class="code" href="a00031.html#caff53a7315dfcce82e06ae11c771e8c">FS_STRING</a> sz_name , U8 u8_size_max , Bool b_mode , Bool b_match_case )
<a name="l01608"></a>01608 {
<a name="l01609"></a>01609    U8 u8_pos_name;
<a name="l01610"></a>01610    <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01611"></a>01611    U16 u16_unicode_entry;
<a name="l01612"></a>01612    U16 u16_unicode_szname;
<a name="l01613"></a>01613 
<a name="l01614"></a>01614    ptr_entry = <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>();
<a name="l01615"></a>01615 
<a name="l01616"></a>01616    <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#453bf57f059970b3ce13033b7959cb0c">FS_ENTRY_END</a> == *ptr_entry )            <span class="comment">// end of directory</span>
<a name="l01617"></a>01617    ||  (<a class="code" href="a00025.html#303c1237fa5a61ddc015c0365eedd008">FS_ENTRY_DEL</a> == *ptr_entry )            <span class="comment">// entry deleted</span>
<a name="l01618"></a>01618    ||  (<a class="code" href="a00031.html#1aa64d79e89a455b62036d2230fd718d">FS_ATTR_LFN_ENTRY</a> != ptr_entry[11]) )   <span class="comment">// no long name</span>
<a name="l01619"></a>01619    {
<a name="l01620"></a>01620       <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#934f48a8e1cb558d75ec00bbd242030d" title="File entry bad.">FS_ERR_ENTRY_BAD</a>;
<a name="l01621"></a>01621       <span class="keywordflow">return</span> FALSE;
<a name="l01622"></a>01622    }
<a name="l01623"></a>01623 
<a name="l01624"></a>01624    <span class="keywordflow">if</span>( <a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01625"></a>01625    {
<a name="l01626"></a>01626       <span class="keywordflow">if</span> ( 0 == (<a class="code" href="a00025.html#bf0fa999d28907c3742656b6407aca78">FS_ENTRY_LFN_LAST</a> &amp; *ptr_entry))
<a name="l01627"></a>01627       {
<a name="l01628"></a>01628          <span class="comment">// no necessary -&gt; ((FS_STR_UNICODE)sz_name)[0] = FS_SIZE_LFN_ENTRY;</span>
<a name="l01629"></a>01629          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#2dad540bd4ed9c78eff34ba269371d8d" title="The file entry isn&amp;#39;t the last long file entry.">FS_NO_LAST_LFN_ENTRY</a>;
<a name="l01630"></a>01630          <span class="keywordflow">return</span> FALSE;                          <span class="comment">// Other entry long name</span>
<a name="l01631"></a>01631       }
<a name="l01632"></a>01632    }
<a name="l01633"></a>01633 
<a name="l01634"></a>01634    ptr_entry++;                                 <span class="comment">// The long name start at offset 1 of the entry file</span>
<a name="l01635"></a>01635 
<a name="l01636"></a>01636    u8_pos_name=0;
<a name="l01637"></a>01637    <span class="keywordflow">while</span>( 1 )
<a name="l01638"></a>01638    {
<a name="l01639"></a>01639       LSB(u16_unicode_entry) = ptr_entry[0];
<a name="l01640"></a>01640       MSB(u16_unicode_entry) = ptr_entry[1];
<a name="l01641"></a>01641       <span class="keywordflow">if</span>( <a class="code" href="a00031.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode )
<a name="l01642"></a>01642       {
<a name="l01643"></a>01643          <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01644"></a>01644          {
<a name="l01645"></a>01645             <span class="comment">// Check the end of buffer</span>
<a name="l01646"></a>01646             <span class="keywordflow">if</span>( u8_pos_name&gt;=(u8_size_max-1) )
<a name="l01647"></a>01647             {
<a name="l01648"></a>01648                <span class="comment">// Write end of string</span>
<a name="l01649"></a>01649                <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01650"></a>01650                {
<a name="l01651"></a>01651                   ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = 0;
<a name="l01652"></a>01652                }<span class="keywordflow">else</span>{
<a name="l01653"></a>01653                   sz_name[0] = 0;
<a name="l01654"></a>01654                }
<a name="l01655"></a>01655                <span class="keywordflow">return</span> TRUE;                     <span class="comment">// the buffer is full</span>
<a name="l01656"></a>01656             }
<a name="l01657"></a>01657             <span class="comment">// Read and store the long name</span>
<a name="l01658"></a>01658             <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01659"></a>01659             {
<a name="l01660"></a>01660                ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = u16_unicode_entry;
<a name="l01661"></a>01661             }<span class="keywordflow">else</span>{
<a name="l01662"></a>01662                sz_name[0] = (U8)u16_unicode_entry;
<a name="l01663"></a>01663             }
<a name="l01664"></a>01664          }
<a name="l01665"></a>01665       }
<a name="l01666"></a>01666       <span class="keywordflow">else</span>
<a name="l01667"></a>01667       {
<a name="l01668"></a>01668          <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01669"></a>01669          {
<a name="l01670"></a>01670             u16_unicode_szname = ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0];
<a name="l01671"></a>01671          }<span class="keywordflow">else</span>{
<a name="l01672"></a>01672             u16_unicode_szname = sz_name[0];
<a name="l01673"></a>01673          }
<a name="l01674"></a>01674          <span class="comment">// Check the name</span>
<a name="l01675"></a>01675          <span class="keywordflow">if</span>( <span class="charliteral">'*'</span> == u16_unicode_szname )
<a name="l01676"></a>01676          {  <span class="comment">// end of filter name which autorise all next character</span>
<a name="l01677"></a>01677             <span class="keywordflow">return</span> TRUE;   <span class="comment">//*** The name is correct ***</span>
<a name="l01678"></a>01678          }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680          <span class="keywordflow">if</span>( ((0 != u16_unicode_entry ) || (( <span class="charliteral">'\\'</span> != u16_unicode_szname) &amp;&amp; ( <span class="charliteral">'/'</span> != u16_unicode_szname)) )
<a name="l01681"></a>01681          &amp;&amp;  ((u16_unicode_szname != (u16_unicode_entry+(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) || b_match_case)
<a name="l01682"></a>01682          &amp;&amp;  ((u16_unicode_szname != (u16_unicode_entry-(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) || b_match_case)
<a name="l01683"></a>01683          &amp;&amp;  (u16_unicode_szname != u16_unicode_entry) )
<a name="l01684"></a>01684          {
<a name="l01685"></a>01685            <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#5ea145bbe1eb7413020b5e6b6f12a1ba" title="The name don&amp;#39;t corresponding at the filter name.">FS_ERR_NAME_INCORRECT</a>; <span class="comment">//  The name don't corresponding at filter name</span>
<a name="l01686"></a>01686            <span class="keywordflow">return</span> FALSE;
<a name="l01687"></a>01687          }
<a name="l01688"></a>01688       }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690       <span class="keywordflow">if</span>( 0 == u16_unicode_entry)
<a name="l01691"></a>01691       {
<a name="l01692"></a>01692          <span class="keywordflow">if</span>( <a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01693"></a>01693          {
<a name="l01694"></a>01694             ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = u8_pos_name+1;
<a name="l01695"></a>01695          }
<a name="l01696"></a>01696          <span class="keywordflow">return</span> TRUE;                           <span class="comment">// Last long name entry</span>
<a name="l01697"></a>01697       }
<a name="l01698"></a>01698       <span class="keywordflow">if</span>( 4 == u8_pos_name )
<a name="l01699"></a>01699          ptr_entry += 3;                        <span class="comment">// Go to second character</span>
<a name="l01700"></a>01700 
<a name="l01701"></a>01701       <span class="keywordflow">if</span>( 10 == u8_pos_name )
<a name="l01702"></a>01702          ptr_entry += 2;                        <span class="comment">// Go to third character</span>
<a name="l01703"></a>01703 
<a name="l01704"></a>01704       <span class="keywordflow">if</span>( 12 == u8_pos_name )
<a name="l01705"></a>01705       {  <span class="comment">// End of entry long name</span>
<a name="l01706"></a>01706          ptr_entry -= (<a class="code" href="a00025.html#0ff67916e073882d162d5fbac91d7e50">FS_SIZE_FILE_ENTRY</a>-2);   <span class="comment">// Go to the first byte of the file entry</span>
<a name="l01707"></a>01707          <span class="keywordflow">if</span> ( 0 == (<a class="code" href="a00025.html#bf0fa999d28907c3742656b6407aca78">FS_ENTRY_LFN_LAST</a> &amp; ptr_entry[0]))
<a name="l01708"></a>01708          {
<a name="l01709"></a>01709             <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#2dad540bd4ed9c78eff34ba269371d8d" title="The file entry isn&amp;#39;t the last long file entry.">FS_NO_LAST_LFN_ENTRY</a>;
<a name="l01710"></a>01710             <span class="keywordflow">return</span> FALSE;                       <span class="comment">// Other long name entry is present</span>
<a name="l01711"></a>01711          }
<a name="l01712"></a>01712          <span class="keywordflow">else</span>
<a name="l01713"></a>01713          {  <span class="comment">// It is the last long name entry</span>
<a name="l01714"></a>01714             <span class="comment">// then it is the end of name</span>
<a name="l01715"></a>01715             <span class="keywordflow">if</span>( (<a class="code" href="a00031.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode) &amp;&amp; <a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01716"></a>01716             {
<a name="l01717"></a>01717                ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = 14;
<a name="l01718"></a>01718                <span class="keywordflow">return</span> TRUE;
<a name="l01719"></a>01719             }
<a name="l01720"></a>01720             sz_name += (<a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01721"></a>01721             <span class="keywordflow">if</span>( <a class="code" href="a00031.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode )
<a name="l01722"></a>01722             {
<a name="l01723"></a>01723                <span class="comment">// Write end of string UNICODE</span>
<a name="l01724"></a>01724                <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01725"></a>01725                {
<a name="l01726"></a>01726                   ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = 0;
<a name="l01727"></a>01727                }<span class="keywordflow">else</span>{
<a name="l01728"></a>01728                   sz_name[0] = 0;
<a name="l01729"></a>01729                }
<a name="l01730"></a>01730                <span class="keywordflow">return</span> TRUE;
<a name="l01731"></a>01731             }
<a name="l01732"></a>01732             <span class="keywordflow">else</span>
<a name="l01733"></a>01733             {
<a name="l01734"></a>01734                <span class="comment">// if it is the end of filter</span>
<a name="l01735"></a>01735                <span class="keywordflow">if</span>( <a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01736"></a>01736                {
<a name="l01737"></a>01737                   u16_unicode_szname = ((<a class="code" href="a00031.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0];
<a name="l01738"></a>01738                }<span class="keywordflow">else</span>{
<a name="l01739"></a>01739                   u16_unicode_szname = sz_name[0];
<a name="l01740"></a>01740                }
<a name="l01741"></a>01741                <span class="keywordflow">return</span> <a class="code" href="a00024.html#452e159ed5e2a4d8ea88f0515a3a6e10" title="Check end of name.">fat_check_eof_name</a>(u16_unicode_szname);
<a name="l01742"></a>01742             }
<a name="l01743"></a>01743          }
<a name="l01744"></a>01744       }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746       <span class="keywordflow">if</span>( !<a class="code" href="a00025.html#6d450fc3016f0d8a7f5674d9e3a05c83" title="Variables to select LENGTH string mode (initialised in nav_reset()).">g_b_string_length</a> )
<a name="l01747"></a>01747       {
<a name="l01748"></a>01748          sz_name += (<a class="code" href="a00025.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01749"></a>01749       }
<a name="l01750"></a>01750       u8_pos_name++;
<a name="l01751"></a>01751       ptr_entry+=2;
<a name="l01752"></a>01752    }
<a name="l01753"></a>01753 }
<a name="l01754"></a>01754 
<a name="l01755"></a>01755 
<a name="l01763"></a><a class="code" href="a00025.html#452e159ed5e2a4d8ea88f0515a3a6e10">01763</a> Bool  <a class="code" href="a00024.html#452e159ed5e2a4d8ea88f0515a3a6e10" title="Check end of name.">fat_check_eof_name</a>( U16 character )
<a name="l01764"></a>01764 {
<a name="l01765"></a>01765    <span class="keywordflow">return</span> ((<span class="charliteral">'\0'</span>==character)||(<span class="charliteral">'\\'</span>==character)||(<span class="charliteral">'/'</span>==character));
<a name="l01766"></a>01766 }
<a name="l01767"></a>01767 
<a name="l01768"></a>01768 
<a name="l01773"></a><a class="code" href="a00025.html#0c24a717d004b7194e2c566522348fd5">01773</a> <a class="code" href="a00025.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> <a class="code" href="a00024.html#0c24a717d004b7194e2c566522348fd5" title="This function returns a cache pointer on the current entry.">fat_get_ptr_entry</a>( <span class="keywordtype">void</span> )
<a name="l01774"></a>01774 {
<a name="l01775"></a>01775    <span class="keywordflow">return</span> &amp;<a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>[(<a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#9f50297ed427918e54da99b8c4fbaf04" title="Entry file position in directory (unit = FS_SIZE_FILE_ENTRY) (see value FS_NO_SEL...">u16_entry_pos_sel_file</a> * <a class="code" href="a00025.html#0ff67916e073882d162d5fbac91d7e50">FS_SIZE_FILE_ENTRY</a>) &amp; <a class="code" href="a00025.html#88ac363f9c597edc80e1185f99434056">FS_512B_MASK</a>];
<a name="l01776"></a>01776 }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778 
<a name="l01794"></a><a class="code" href="a00025.html#a67dc439478853cefdd226f9c99c9539">01794</a> Bool  <a class="code" href="a00024.html#a67dc439478853cefdd226f9c99c9539" title="This function loads a memory sector in internal cache sector.">fat_cache_read_sector</a>( Bool b_load )
<a name="l01795"></a>01795 {
<a name="l01796"></a>01796    <span class="comment">// Check if the sector asked is the same in cache</span>
<a name="l01797"></a>01797    <span class="keywordflow">if</span>( (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a>     == <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l01798"></a>01798    &amp;&amp;  (<a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#fe852c5721ec70a1942bcebca4e370c9" title="Sector address (unit 512B).">u32_addr</a>   == <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a> ) )
<a name="l01799"></a>01799    {
<a name="l01800"></a>01800       <span class="keywordflow">return</span> TRUE;
<a name="l01801"></a>01801    }
<a name="l01802"></a>01802 
<a name="l01803"></a>01803    <span class="comment">// Write previous cache before fill cache with a new sector</span>
<a name="l01804"></a>01804    <span class="keywordflow">if</span>( !<a class="code" href="a00024.html#578ab4800128cde17c0820a5027c1c06" title="This function flushs the sector cache on the memory if necessary.">fat_cache_flush</a>())
<a name="l01805"></a>01805       <span class="keywordflow">return</span> FALSE;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807    <span class="comment">// Delete informations about the caches</span>
<a name="l01808"></a>01808    <a class="code" href="a00024.html#961692919a93b6cb714ec2a3d57c0141" title="This function resets the sector cache.">fat_cache_reset</a>();
<a name="l01809"></a>01809 
<a name="l01810"></a>01810    <span class="comment">// Init sector cache</span>
<a name="l01811"></a>01811    <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#fe852c5721ec70a1942bcebca4e370c9" title="Sector address (unit 512B).">u32_addr</a> = <a class="code" href="a00025.html#8e617688fc42b47e56cce053123fd05f" title="Store the address of futur cache (unit 512B).">fs_gu32_addrsector</a>;
<a name="l01812"></a>01812    <span class="keywordflow">if</span>( b_load )
<a name="l01813"></a>01813    {
<a name="l01814"></a>01814       <span class="comment">// Load the sector from memory</span>
<a name="l01815"></a>01815       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8" title="Success, memory ready.">CTRL_GOOD</a> != <a class="code" href="a00022.html#dde05eb39b542eb5a7d3f78cf7006f28" title="Copies 1 data sector from the memory to RAM.">memory_2_ram</a>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a>  , <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#fe852c5721ec70a1942bcebca4e370c9" title="Sector address (unit 512B).">u32_addr</a>, <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a>))
<a name="l01816"></a>01816       {
<a name="l01817"></a>01817          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#cf37e5255ee1dbfaab77def32a7cbbef" title="Hardware driver error.">FS_ERR_HW</a>;
<a name="l01818"></a>01818          <span class="keywordflow">return</span> FALSE;
<a name="l01819"></a>01819       }
<a name="l01820"></a>01820    }
<a name="l01821"></a>01821    <span class="comment">// Valid sector cache</span>
<a name="l01822"></a>01822    <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a> = <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a>;
<a name="l01823"></a>01823    <span class="keywordflow">return</span> TRUE;
<a name="l01824"></a>01824 }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826 
<a name="l01829"></a><a class="code" href="a00025.html#961692919a93b6cb714ec2a3d57c0141">01829</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#961692919a93b6cb714ec2a3d57c0141" title="This function resets the sector cache.">fat_cache_reset</a>( <span class="keywordtype">void</span> )
<a name="l01830"></a>01830 {
<a name="l01831"></a>01831    <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a>                = <a class="code" href="a00025.html#0b62220f198f7eb96b15aa863c49ce54" title="Signal that sector cache is not valid.">FS_BUF_SECTOR_EMPTY</a>;
<a name="l01832"></a>01832    <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#b7c05aed70b9dd29519e3b3f9b06a709" title="Cache status if the sector is a sector from a cluster list THEN.">u8_dirty</a>              = FALSE;
<a name="l01833"></a>01833    <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#9aba32679527ef002f0bbf18545108cf" title="first cluster of cluster list">u32_clusterlist_start</a> = 0xFFFFFFFF;
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836 
<a name="l01837"></a>01837 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l01840"></a><a class="code" href="a00025.html#5948c1de515852418670d3fb8ae1e832">01840</a> <span class="preprocessor">void  fat_cache_clear( void )</span>
<a name="l01841"></a>01841 <span class="preprocessor"></span>{
<a name="l01842"></a>01842    memset( <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a> , 0 , <a class="code" href="a00025.html#1f24fc24a15f2e52ecae58ae2d5dfbfc">FS_CACHE_SIZE</a> );
<a name="l01843"></a>01843 }
<a name="l01844"></a>01844 
<a name="l01845"></a>01845 
<a name="l01848"></a><a class="code" href="a00025.html#45c0f16885c9e414ddb4b5afaa1cde34">01848</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#45c0f16885c9e414ddb4b5afaa1cde34" title="This function sets a flag to signal that sector cache is modified.">fat_cache_mark_sector_as_dirty</a>( <span class="keywordtype">void</span> )
<a name="l01849"></a>01849 {
<a name="l01850"></a>01850    <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#b7c05aed70b9dd29519e3b3f9b06a709" title="Cache status if the sector is a sector from a cluster list THEN.">u8_dirty</a> = TRUE;
<a name="l01851"></a>01851 }
<a name="l01852"></a>01852 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01853"></a>01853 <span class="preprocessor"></span>
<a name="l01854"></a>01854 
<a name="l01860"></a><a class="code" href="a00025.html#578ab4800128cde17c0820a5027c1c06">01860</a> Bool  <a class="code" href="a00024.html#578ab4800128cde17c0820a5027c1c06" title="This function flushs the sector cache on the memory if necessary.">fat_cache_flush</a>( <span class="keywordtype">void</span> )
<a name="l01861"></a>01861 {
<a name="l01862"></a>01862    <span class="comment">// If the cache is modified, then write the sector cache on the device</span>
<a name="l01863"></a>01863    <span class="keywordflow">if</span> ( TRUE == <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#b7c05aed70b9dd29519e3b3f9b06a709" title="Cache status if the sector is a sector from a cluster list THEN.">u8_dirty</a> )
<a name="l01864"></a>01864    {
<a name="l01865"></a>01865       <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#b7c05aed70b9dd29519e3b3f9b06a709" title="Cache status if the sector is a sector from a cluster list THEN.">u8_dirty</a> = FALSE; <span class="comment">// Always clear, although an error occur</span>
<a name="l01866"></a>01866       <span class="keywordflow">if</span>( <a class="code" href="a00022.html#f4b64acad5f46d01e082d7a7301078df" title="Returns the write-protection state of the memory.">mem_wr_protect</a>( <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a>  ))
<a name="l01867"></a>01867       {
<a name="l01868"></a>01868          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#3e74c914900316653d8cfdef780447c8" title="Drive is in read only mode.">FS_LUN_WP</a>;
<a name="l01869"></a>01869          <span class="keywordflow">return</span> FALSE;
<a name="l01870"></a>01870       }
<a name="l01871"></a>01871       <span class="keywordflow">if</span> (<a class="code" href="a00023.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8" title="Success, memory ready.">CTRL_GOOD</a> != <a class="code" href="a00022.html#61739dc73f8bff39c3d291f2e47a5bce" title="Copies 1 data sector from RAM to the memory.">ram_2_memory</a>( <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#983c3e8973f75815f64897cfdcacd10e" title="LUN of sector.">u8_lun</a> , <a class="code" href="a00025.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00013.html#fe852c5721ec70a1942bcebca4e370c9" title="Sector address (unit 512B).">u32_addr</a> , <a class="code" href="a00025.html#a84f1da7d8ef3aa46b236f6a7a3b0fa1" title="Use &amp;quot;FAT sector cache&amp;quot; to store a sector from a file (see file_putc(),...">fs_g_sector</a> ))
<a name="l01872"></a>01872       {
<a name="l01873"></a>01873          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#cf37e5255ee1dbfaab77def32a7cbbef" title="Hardware driver error.">FS_ERR_HW</a>;
<a name="l01874"></a>01874          <span class="keywordflow">return</span> FALSE;
<a name="l01875"></a>01875       }
<a name="l01876"></a>01876    }
<a name="l01877"></a>01877    <span class="keywordflow">return</span> TRUE;
<a name="l01878"></a>01878 }
<a name="l01879"></a>01879 
<a name="l01880"></a>01880 
<a name="l01881"></a>01881 
<a name="l01882"></a>01882 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l01888"></a><a class="code" href="a00025.html#3ebe58d94472a1818a38afaf09c19c35">01888</a> <span class="preprocessor">Bool  fat_check_nav_access_disk( void )</span>
<a name="l01889"></a>01889 <span class="preprocessor"></span>{
<a name="l01890"></a>01890    U8 i;
<a name="l01891"></a>01891 
<a name="l01892"></a>01892    <span class="comment">// For each navigators</span>
<a name="l01893"></a>01893    <span class="keywordflow">for</span>( i=0 ; i!=(<a class="code" href="a00021.html#8ab6bd77e49639be7dc419bcf66bd73f" title="Maximal number of simultaneous navigators.">FS_NB_NAVIGATOR</a>-1) ; i++ )
<a name="l01894"></a>01894    {
<a name="l01895"></a>01895       <span class="comment">// Disk mounted ?</span>
<a name="l01896"></a>01896       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#429fbd0498704c3d5864877548040069" title="Partition not mounted.">FS_TYPE_FAT_UNM</a> != <a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[i].u8_type_fat )
<a name="l01897"></a>01897       <span class="comment">// Is it the same disk ?</span>
<a name="l01898"></a>01898       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> == <a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l01899"></a>01899       <span class="comment">// Is it access file ?</span>
<a name="l01900"></a>01900       <span class="keywordflow">if</span>( <a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].u8_open_mode!=0 )
<a name="l01901"></a>01901       {
<a name="l01902"></a>01902          <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#65f54d5e9ae9fb0958d6be4d1fb919c7" title="The file is already opened.">FS_ERR_FILE_OPEN</a>;
<a name="l01903"></a>01903          <span class="keywordflow">return</span> FALSE;  <span class="comment">// File opened then write access not possibled</span>
<a name="l01904"></a>01904       }
<a name="l01905"></a>01905    }
<a name="l01906"></a>01906    <span class="keywordflow">return</span> TRUE;
<a name="l01907"></a>01907 }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 
<a name="l01920"></a><a class="code" href="a00025.html#07f36d38eda0af16ef7ef899129d7e7b">01920</a> Bool  <a class="code" href="a00024.html#07f36d38eda0af16ef7ef899129d7e7b" title="This function checks all access at current file.">fat_check_nav_access_file</a>( Bool mode )
<a name="l01921"></a>01921 {
<a name="l01922"></a>01922    U8 i;
<a name="l01923"></a>01923 
<a name="l01924"></a>01924    <span class="comment">// For each navigators</span>
<a name="l01925"></a>01925    <span class="keywordflow">for</span>( i=0 ; i!=(<a class="code" href="a00021.html#8ab6bd77e49639be7dc419bcf66bd73f" title="Maximal number of simultaneous navigators.">FS_NB_NAVIGATOR</a>-1) ; i++ )
<a name="l01926"></a>01926    {
<a name="l01927"></a>01927       <span class="comment">// Disk mounted ?</span>
<a name="l01928"></a>01928       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#429fbd0498704c3d5864877548040069" title="Partition not mounted.">FS_TYPE_FAT_UNM</a> != <a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[i].u8_type_fat )
<a name="l01929"></a>01929       <span class="comment">// Is it the same disk ?</span>
<a name="l01930"></a>01930       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> == <a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00009.html#43065262a1a7560b143e0b48cbf5ccbd" title="Number of logical driver.">u8_lun</a> )
<a name="l01931"></a>01931 <span class="preprocessor">#if (FS_MULTI_PARTITION == ENABLED)</span>
<a name="l01932"></a>01932 <span class="preprocessor"></span>      <span class="comment">// Is it the same partition ?</span>
<a name="l01933"></a>01933       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#af482bc02a186c363c37c93e169fbbd4" title="Number of partition - 1 (0 or 1).">u8_partition</a> == <a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00009.html#af482bc02a186c363c37c93e169fbbd4" title="Number of partition - 1 (0 or 1).">u8_partition</a> )
<a name="l01934"></a>01934 <span class="preprocessor">#endif</span>
<a name="l01935"></a>01935 <span class="preprocessor"></span>      <span class="comment">// Is it the same directory ?</span>
<a name="l01936"></a>01936       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00009.html#ed8faad36e96ff2f422ddadd3740713f" title="First cluster number of selected directory (0 for the root directory).">u32_cluster_sel_dir</a> == <a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00009.html#ed8faad36e96ff2f422ddadd3740713f" title="First cluster number of selected directory (0 for the root directory).">u32_cluster_sel_dir</a> )
<a name="l01937"></a>01937       <span class="comment">// Is it the same file ?</span>
<a name="l01938"></a>01938       <span class="keywordflow">if</span>( <a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00011.html#9f50297ed427918e54da99b8c4fbaf04" title="Entry file position in directory (unit = FS_SIZE_FILE_ENTRY) (see value FS_NO_SEL...">u16_entry_pos_sel_file</a> == <a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[i].<a class="code" href="a00011.html#9f50297ed427918e54da99b8c4fbaf04" title="Entry file position in directory (unit = FS_SIZE_FILE_ENTRY) (see value FS_NO_SEL...">u16_entry_pos_sel_file</a> )
<a name="l01939"></a>01939       {
<a name="l01940"></a>01940          <span class="keywordflow">if</span>( mode )
<a name="l01941"></a>01941          {
<a name="l01942"></a>01942             <span class="comment">// Is it open ?</span>
<a name="l01943"></a>01943             <span class="keywordflow">if</span>( <a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].u8_open_mode!=0 )
<a name="l01944"></a>01944             {
<a name="l01945"></a>01945                <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#65f54d5e9ae9fb0958d6be4d1fb919c7" title="The file is already opened.">FS_ERR_FILE_OPEN</a>;
<a name="l01946"></a>01946                <span class="keywordflow">return</span> FALSE;  <span class="comment">// File opened then write access not possibled</span>
<a name="l01947"></a>01947             }
<a name="l01948"></a>01948          }
<a name="l01949"></a>01949          <span class="keywordflow">else</span>
<a name="l01950"></a>01950          {
<a name="l01951"></a>01951             <span class="comment">// Is it open in write mode ?</span>
<a name="l01952"></a>01952             <span class="keywordflow">if</span>( <a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].u8_open_mode &amp; <a class="code" href="a00031.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> )
<a name="l01953"></a>01953             {
<a name="l01954"></a>01954                <a class="code" href="a00031.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00031.html#5b438435c3686cdce1a51be28a732565" title="The file is already opened in write mode.">FS_ERR_FILE_OPEN_WR</a>;
<a name="l01955"></a>01955                <span class="keywordflow">return</span> FALSE;  <span class="comment">// File opened in write mode then read access not possibled</span>
<a name="l01956"></a>01956             }
<a name="l01957"></a>01957          }
<a name="l01958"></a>01958       }
<a name="l01959"></a>01959    }
<a name="l01960"></a>01960    <span class="keywordflow">return</span> TRUE;
<a name="l01961"></a>01961 }
<a name="l01962"></a>01962 
<a name="l01963"></a>01963 
<a name="l01968"></a><a class="code" href="a00025.html#65cfc6e07b1a1bc3a12d564148daca37">01968</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#65cfc6e07b1a1bc3a12d564148daca37" title="This function inverts the current navigation with another.">fat_invert_nav</a>( U8 u8_idnav )
<a name="l01969"></a>01969 {
<a name="l01970"></a>01970    _MEM_TYPE_SLOW_ U8 Temp[Max(Max(<span class="keyword">sizeof</span>(<a class="code" href="a00009.html" title="Struture to save the variables frequently used by file system mounted.">Fs_management</a>),<span class="keyword">sizeof</span>(<a class="code" href="a00010.html" title="Struture to save the frequently variables of file system mounted.">Fs_management_entry</a>)),<span class="keyword">sizeof</span>(<a class="code" href="a00011.html" title="Struture to save the variables very frequently used by file system mounted.">Fs_management_fast</a>))];
<a name="l01971"></a>01971 
<a name="l01972"></a>01972    <span class="keywordflow">if</span>( u8_idnav == 0 )
<a name="l01973"></a>01973       <span class="keywordflow">return</span>;
<a name="l01974"></a>01974    u8_idnav--;
<a name="l01975"></a>01975 
<a name="l01976"></a>01976    memcpy_ram2ram(Temp,                              (U8*)&amp;<a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>,                     <span class="keyword">sizeof</span>(<a class="code" href="a00009.html" title="Struture to save the variables frequently used by file system mounted.">Fs_management</a>));
<a name="l01977"></a>01977    memcpy_ram2ram((U8*)&amp;fs_g_nav,                    (U8*)&amp;<a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[u8_idnav],        <span class="keyword">sizeof</span>(<a class="code" href="a00009.html" title="Struture to save the variables frequently used by file system mounted.">Fs_management</a>));
<a name="l01978"></a>01978    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[u8_idnav],       Temp,                               <span class="keyword">sizeof</span>(<a class="code" href="a00009.html" title="Struture to save the variables frequently used by file system mounted.">Fs_management</a>));
<a name="l01979"></a>01979 
<a name="l01980"></a>01980    memcpy_ram2ram(Temp,                              (U8*)&amp;<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>,               <span class="keyword">sizeof</span>(<a class="code" href="a00010.html" title="Struture to save the frequently variables of file system mounted.">Fs_management_entry</a>));
<a name="l01981"></a>01981    memcpy_ram2ram((U8*)&amp;fs_g_nav_entry,              (U8*)&amp;<a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav],  <span class="keyword">sizeof</span>(<a class="code" href="a00010.html" title="Struture to save the frequently variables of file system mounted.">Fs_management_entry</a>));
<a name="l01982"></a>01982    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav], Temp,                               <span class="keyword">sizeof</span>(<a class="code" href="a00010.html" title="Struture to save the frequently variables of file system mounted.">Fs_management_entry</a>));
<a name="l01983"></a>01983 
<a name="l01984"></a>01984    memcpy_ram2ram(Temp,                              (U8*)&amp;<a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>,                <span class="keyword">sizeof</span>(<a class="code" href="a00011.html" title="Struture to save the variables very frequently used by file system mounted.">Fs_management_fast</a>));
<a name="l01985"></a>01985    memcpy_ram2ram((U8*)&amp;fs_g_nav_fast,               (U8*)&amp;<a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[u8_idnav],   <span class="keyword">sizeof</span>(<a class="code" href="a00011.html" title="Struture to save the variables very frequently used by file system mounted.">Fs_management_fast</a>));
<a name="l01986"></a>01986    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[u8_idnav],  Temp,                               <span class="keyword">sizeof</span>(<a class="code" href="a00011.html" title="Struture to save the variables very frequently used by file system mounted.">Fs_management_fast</a>));
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989 
<a name="l01994"></a><a class="code" href="a00025.html#1d133b71ef98fe5945a358bf46680504">01994</a> <span class="keywordtype">void</span>  <a class="code" href="a00024.html#1d133b71ef98fe5945a358bf46680504" title="This function copys the main navigator to another navigator.">fat_copy_nav</a>( U8 u8_idnav )
<a name="l01995"></a>01995 {
<a name="l01996"></a>01996    <span class="keywordflow">if</span>( 0 != u8_idnav)
<a name="l01997"></a>01997    {
<a name="l01998"></a>01998       u8_idnav--;
<a name="l01999"></a>01999       memcpy_ram2ram((U8*)&amp;<a class="code" href="a00024.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[u8_idnav],       (U8*)&amp;<a class="code" href="a00025.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>       , <span class="keyword">sizeof</span>(<a class="code" href="a00009.html" title="Struture to save the variables frequently used by file system mounted.">Fs_management</a>) );
<a name="l02000"></a>02000       memcpy_ram2ram((U8*)&amp;<a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav], (U8*)&amp;<a class="code" href="a00025.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a> , <span class="keyword">sizeof</span>(<a class="code" href="a00010.html" title="Struture to save the frequently variables of file system mounted.">Fs_management_entry</a>) );
<a name="l02001"></a>02001       memcpy_ram2ram((U8*)&amp;<a class="code" href="a00024.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[u8_idnav],  (U8*)&amp;<a class="code" href="a00025.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>  , <span class="keyword">sizeof</span>(<a class="code" href="a00011.html" title="Struture to save the variables very frequently used by file system mounted.">Fs_management_fast</a>) );
<a name="l02002"></a>02002       <a class="code" href="a00024.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav].<a class="code" href="a00010.html#316b7df1bf2c7e55453f17ad00290447" title="open mode of selected file">u8_open_mode</a>=0;   <span class="comment">// Clear open file flag</span>
<a name="l02003"></a>02003    }
<a name="l02004"></a>02004 }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006 <span class="preprocessor">#endif</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Dec 21 18:30:18 2009 for AVR32 - FAT Services by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
